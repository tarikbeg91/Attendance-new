<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="appTitle">Attendance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- Start of CSS --- */
        :root {
            --background-color: #f4f4f4;
            --text-color: #333;
            --container-bg-color: #fff;
            --border-color: #ddd;
            --input-bg: #fff;
            --input-text: #333;
            --input-placeholder: #bbb;
            --table-bg: #fff;
            --table-header-bg: #ddd;

            /* Button Variables (Light Mode Defaults) */
            --default-button-bg: transparent;
            --default-button-text: #333;
            --default-button-border: #ccc;
            --default-button-hover-bg: #e9e9e9;
            --default-button-hover-border: #adadad;

            --primary-color: #007bff;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --reminder-bg: #ffc107;
            --reminder-text: #343a40;
            --current-day-bg: #e0e0e0;
            --icon-placeholder-color: #bbb; /* Light mode default */
            --link-color: #0056b3; /* Added for hover effect */
            --text-color-secondary: #555; /* For day name */

            /* Friday/Sunday highlighting - Lighter versions */
            --friday-bg-light: #f0fff9;
            --friday-border-light: #239c88; /* Specific border color for Friday */
            --sunday-bg-light: #fff5f7;
            --sunday-border-light: #e53e3e; /* Specific border color for Sunday */

            /* Save Status Indicator Colors */
            --save-success-bg: #4CAF50;
            --save-saving-bg: var(--warning-color);
            --save-error-bg: var(--danger-color);
            --save-text-color: white;
        }

        html.dark {
            --background-color: #1a202c;
            --text-color: #a0aec0; /* Slightly lighter text for dark background */
            --container-bg-color: #2d3748; /* Darker background for main containers */
            --border-color: #4a5568;
            --input-bg: #2d3748;
            --input-text: #a0aec0;
            --input-placeholder: #718096;
            --table-bg: #2d3748;
            --table-header-bg: #4a5568;

            /* Button Variables (Dark Mode) */
             --default-button-bg: transparent;
             --default-button-text: #a0aec0;
             --default-button-border: #4a5568;
             --default-button-hover-bg: rgba(74, 85, 104, 0.4);
             --default-button-hover-border: #a0aec0;


             --primary-color-dark: #63b3ed;
             --danger-color-dark: #fc8181;
             --warning-color-dark: #f6e05e;
             --reminder-bg: #f6ad55;
             --reminder-text: #2d3748;
            --current-day-bg: #4a5568;
            --icon-placeholder-color-dark: #718096;
             --link-color: #90cdf4;
             --text-color-secondary: #8892b0;

            /* Friday/Sunday highlighting - Dark Mode - Lighter versions */
            --friday-bg-dark: #2a4365;
            --friday-border-dark: #73b8e0; /* Specific border color for Friday in dark mode */
            --sunday-bg-dark: #822c2c;
            --sunday-border-dark: #fca5a5; /* Specific border color for Sunday in dark mode */

            /* Save Status Indicator Colors - Dark Mode */
            --save-success-bg: var(--primary-color-dark);
            --save-saving-bg: var(--warning-color-dark);
            --save-error-bg: var(--danger-color-dark);
            --save-text-color: var(--background-color); /* Use background color for text on dark buttons */
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background-color: var(--container-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        input, select, textarea { /* Added textarea */
            padding: 6px;
            margin: 5px 0;
            font-size: 14px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--input-text);
            box-sizing: border-box;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
         select { cursor: pointer; }
         textarea { resize: vertical; } /* Allow vertical resize for textarea */


        td input {
             border: none; background: none; padding: 0; margin: 0;
             text-align: center; display: block; width: 100%; height: 100%;
             box-sizing: border-box; color: inherit;
         }
         td.edited-datetime-cell {
             padding: 1px 2px;
             vertical-align: middle;
         }
         .edited-date-input, .edited-time-input {
             display: block;
             width: 100%;
             margin: 1px auto;
             text-align: center;
             font-size: 0.80em;
             padding: 2px 1px;
             border: 1px solid var(--border-color);
             background-color: var(--input-bg);
             color: var(--input-text);
             box-sizing: border-box;
             line-height: 1.2;
         }


         input::placeholder, td input::placeholder, textarea::placeholder { color: var(--input-placeholder); opacity: 1; }

         td.rent-cell input[data-field="rent"],
         td.food-cell input[data-field="food"],
         td.received-cell input[data-field="received"] {
            padding-left: 0; text-align: center;
         }

        button {
            cursor: pointer;
            background-color: var(--default-button-bg);
            color: var(--default-button-text);
            border: 1px solid var(--default-button-border);
            border-radius: 4px; padding: 6px 10px;
            margin: 5px; font-size: 16px; min-width: 35px; text-align: center;
            display: inline-block; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        button:hover {
            background-color: var(--default-button-hover-bg);
            border-color: var(--default-button-hover-border);
            color: var(--default-button-text);
        }
        button:disabled { color: #aaa; border-color: #ddd; background-color: transparent; cursor: not-allowed; }
        html.dark button:disabled { color:#5a6578; border-color:#404a59; background-color:transparent; }
        html.dark button:disabled:hover { background-color:transparent; }


         #addUserBtn {
             width: 35px; font-size: 18px; padding: 6px;
             border-color: #4CAF50; color: #4CAF50;
             margin: 5px;
         }
         #addUserBtn:hover { background-color: #4CAF50; color: white; border-color: #4CAF50; }

        html.dark #addUserBtn { border-color:#48bb78; color:#48bb78; }
        html.dark #addUserBtn:hover { background-color:#48bb78; color: var(--background-color); }


        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: var(--table-bg); table-layout: fixed; border: 1px solid var(--border-color); }
         th, td {
            border: 1px solid var(--border-color); padding: 4px; text-align: center;
            word-wrap: break-word; vertical-align: top; position: relative;
         }
         th {
             background-color: var(--table-header-bg); font-weight: bold;
             border-bottom: 1px solid var(--border-color);
             padding: 4px;
             line-height: 1.2;
             color: var(--text-color);
        }

        th:nth-child(1), td:nth-child(1) { width: 90px; } /* Date */
        th:nth-child(2), td:nth-child(2) { width: 25px; } /* Status */
        th:nth-child(3), td:nth-child(3) { width: 25px; } /* Overtime */
        th:nth-child(4), td:nth-child(4) { width: 25px; } /* Rent */
        th:nth-child(5), td:nth-child(5) { width: 25px; } /* Food */
        th:nth-child(6), td:nth-child(6) { width: 25px; } /* Received */
        th:nth-child(7), td:nth-child(7) { width: auto; min-width: 80px; } /* Notes */
        th:nth-child(8), td:nth-child(8) { width: 75px; } /* Edited */

        .day-name-in-date-cell {
            display: block;
            font-size: 0.8em;
            color: var(--text-color-secondary);
            line-height: 1;
            margin-bottom: 2px;
        }
        .notes-cell {
            cursor: pointer;
            text-align: left;
            padding-left: 5px !important;
            vertical-align: middle !important;
        }
        .note-preview {
            display: inline-block;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
            font-size: 0.9em;
            color: var(--input-text);
            min-height: 1.2em;
        }
        html.dark .note-preview {
            color: var(--input-text);
        }


        .rent-cell:not(.input-has-value)::before,
        .food-cell:not(.input-has-value)::before,
        .received-cell:not(.input-has-value)::before {
            font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            color: var(--icon-placeholder-color); opacity: 0.7; font-size: 10px; z-index: 1;
            content: var(--icon-content, "");
        }
        .rent-cell::before { --icon-content: "\f015"; }
        .food-cell::before { --icon-content: "\f2e7"; }
        .received-cell::before { --icon-content: "\f53a"; }

        html.dark .rent-cell:not(.input-has-value)::before,
        html.dark .food-cell:not(.input-has-value)::before,
        html.dark .received-cell:not(.input-has-value)::before {
             color: var(--icon-placeholder-color-dark);
        }
        .input-has-value::before { display: none !important; }

         #userTabs {
             margin-top: 10px; margin-bottom: 20px; padding: 10px;
             background-color: var(--container-bg-color);
             border: 1px solid var(--border-color);
             border-radius: 5px; display: flex; flex-wrap: wrap; gap: 5px;
             display: none;
         }
         #userTabs button.user-tab-button {
             margin: 0; background-color: #f0f0f0; border: 1px solid #ccc; color: #333;
             padding: 4px 8px;
         }
         #userTabs button.user-tab-button:hover { background-color: #dcdcdc; border-color: #bbb; }
         #userTabs button.user-tab-button.active-user-tab {
             background-color: transparent; border: 1px solid var(--primary-color);
             color: var(--primary-color); font-weight: bold;
         }
         #userTabs button.user-tab-button.active-user-tab:hover {
              background-color: rgba(0, 123, 255, 0.1); border-color: #0056b3; color: #0056b3;
         }
         #userTabs button.user-tab-button.archived {
              background-color: transparent; border: 1px dashed #aaa; color: #777;
         }
          #userTabs button.user-tab-button.archived:hover {
              background-color: #f0f0f0; border-color: #888; color: #555;
          }

        html.dark #userTabs button.user-tab-button {
             background-color: rgba(74, 85, 104, 0.5);
             border-color: var(--default-button-border);
             color: var(--default-button-text);
        }
        html.dark #userTabs button.user-tab-button:hover {
             background-color: var(--default-button-hover-bg);
             border-color: var(--default-button-hover-border);
             color: var(--default-button-text);
        }
        html.dark #userTabs button.user-tab-button.active-user-tab {
            background-color: transparent; border-color:var(--primary-color-dark); color:var(--primary-color-dark);
        }
        html.dark #userTabs button.user-tab-button.active-user-tab:hover { background-color:rgba(100,181,246,0.15); }
        html.dark #userTabs button.user-tab-button.archived { border-style:dashed; border-color:#718096; color:#a0aec0; }
        html.dark #userTabs button.user-tab-button.archived:hover { background-color:var(--default-button-hover-bg); }


         #userControl {
             margin-top: 20px; padding: 10px;
             background-color: var(--container-bg-color);
             border: 1px solid var(--border-color);
             border-radius: 5px;
             display: none;
         }
          #userControl > div {
              display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
          }
          #userControl > div:first-child {
              justify-content: space-between;
          }
          #userControl > div:last-child {
              margin-bottom: 0;
          }
          #userQuickControls {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
              align-items: center;
              width: 100%;
              margin-bottom: 15px;
          }
           #userQuickControls > div {
               display: flex;
               align-items: center;
               gap: 5px;
               margin-bottom: 0;
               flex-grow: 1;
               flex-basis: 120px;
               min-width: 100px;
           }
           #userQuickControls label {
               display: none; /* Keep labels for accessibility, but hide visually for compact layout */
           }
           #userQuickControls input,
           #userQuickControls select {
               flex-grow: 1;
               min-width: 0;
               margin: 0;
               font-size: 13px;
               padding: 4px 6px;
               height: calc(1em + 8px + 2px); /* Adjusted for better consistency */
           }
           #userControl button { margin: 0; }

          #monthNavWrapper { width: 100%; margin-bottom: 10px; }
          #monthNav {
             display: flex; justify-content: space-between; align-items: center; width: 100%;
          }
          #monthNav .month-display-group { display: flex; align-items: center; gap: 5px; }
          #monthNav button { padding: 4px 8px; font-size: 14px; margin: 0; }
          #currentMonthDisplay { font-size: 1.1em; font-weight: bold; min-width: 100px; text-align: center; }

          #viewReportButtonsWrapper {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-top: 15px; margin-bottom: 10px; gap: 5px;
            flex-wrap: wrap; /* Allow buttons to wrap */
          }
          #viewReportButtonsWrapper button {
            flex-grow: 1;
            margin: 2px 0; /* Add small vertical margin for wrapped buttons */
            min-width: 120px; /* Ensure buttons don't get too squished */
            font-size: 0.85em; /* Slightly smaller font for more buttons */
            padding: 5px 8px;
        }

          #reportArea { margin-top: 10px; }

         #overallSummarySection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
             display: none;
         }
         #overallSummarySection h3 { margin-top: 0; }
         #overallSummarySection hr { border-color: var(--border-color); margin: 0.5rem 0; }
         #overallSummarySection p { margin: 0.2em 0; }

         #summarySection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
         }
         #summarySection h3 { margin-top: 0; }
         #summarySection hr { border-color: var(--border-color); margin: 0.5rem 0; }
         #summarySection p { margin: 0.2em 0; }

         #reportFooter {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; white-space: pre-wrap; font-size: 0.9em;
         }

         #dataManagementButtons {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
             display: none;
         }
         #dataManagementButtons button { margin: 0; padding: 6px 12px; font-size: 0.9em; }
         #dataManagementButtons button i { margin-right: 5px; }
        #archiveUserBtn.archive-style { border-color: #dc3545; color: #dc3545; }
        #archiveUserBtn.archive-style:hover { background-color: #dc3545; color: white; }
        #archiveUserBtn.reactivate-style { border-color: #ffc107; color: #b7791f; }
        #archiveUserBtn.reactivate-style:hover { background-color: #ffc107; color: #212529; }

        html.dark #archiveUserBtn.archive-style { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
        html.dark #archiveUserBtn.archive-style:hover { background-color:var(--danger-color-dark); color:var(--background-color); }
        html.dark #archiveUserBtn.reactivate-style { border-color:var(--warning-color-dark); color:var(--warning-color-dark); }
        html.dark #archiveUserBtn.reactivate-style:hover { background-color:var(--warning-color-dark); color:var(--reminder-text); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: var(--container-bg-color); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-title { margin: 0; font-size: 1.2em; font-weight: bold; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }
        html.dark .close-button { color: #ccc; }
        html.dark .close-button:hover, html.dark .close-button:focus { color: #fff; }

        .modal-body { margin-bottom: 10px; }
         #modalNoteTextarea {
             width: 100%;
             font-size: 1em;
             padding: 8px;
             box-sizing: border-box;
             border: 1px solid var(--border-color);
             background-color: var(--input-bg);
             color: var(--input-text);
             border-radius: 4px;
             min-height: 80px;
         }
         html.dark #modalNoteTextarea {}

        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 8px 15px; margin: 0; }

        .modal-footer button[onclick*="closeImportModal"] { border-color: #6c757d; color: #6c757d; }
        .modal-footer button[onclick*="closeImportModal"]:hover { background-color: #6c757d; color: white; }
        .modal-footer button[onclick*="confirmImport('merge')"] { border-color: var(--primary-color); color: var(--primary-color); }
        .modal-footer button[onclick*="confirmImport('merge')"]:hover { background-color: var(--primary-color); color: white; }
        .modal-footer button[onclick*="confirmImport('replace')"] { border-color: var(--danger-color); color: var(--danger-color); }
        .modal-footer button[onclick*="confirmImport('replace')"]:hover { background-color: var(--danger-color); color: white; }

        html.dark .modal-footer button[onclick*="closeImportModal"] { border-color:#90a4ae; color:#90a4ae;}
        html.dark .modal-footer button[onclick*="closeImportModal"]:hover { background-color:#90a4ae; color:var(--background-color); }
        html.dark .modal-footer button[onclick*="confirmImport('merge')"] { border-color:var(--primary-color-dark); color:var(--primary-color-dark); }
        html.dark .modal-footer button[onclick*="confirmImport('merge')"]:hover { background-color:var(--primary-color-dark); color:var(--background-color); }
        html.dark .modal-footer button[onclick*="confirmImport('replace')"] { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
        html.dark .modal-footer button[onclick*="confirmImport('replace')"]:hover { background-color:var(--danger-color-dark); color:var(--background-color); }

        .preview-section { border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .preview-header { font-weight: bold; margin-bottom: 5px; }
        .user-preview { border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; background-color: var(--input-bg); margin-top: 10px; }
        .user-preview p { margin: 0.3em 0; font-size: 0.9em; }
        .import-option { margin-top: 15px; }
        .import-option ul { list-style: disc inside; margin: 0; padding-left: 20px; }
        .import-option li { margin-bottom: 5px; }

        #previousBalancePaymentsSection {
             margin-top: 10px; padding: 10px;
             background-color: var(--container-bg-color); border: 1px solid var(--border-color);
             border-radius: 5px; margin-bottom: 10px;
             display: none;
         }
         #previousBalancePaymentsSection h3 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
         #previousBalancePaymentsSection .payment-entry { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #eee; }
         html.dark #previousBalancePaymentsSection .payment-entry { border-bottom-color: rgba(255,255,255,0.1); }

         #previousBalancePaymentsSection .payment-entry:last-child { border-bottom: none; }
         #previousBalancePaymentsSection .payment-details { flex-grow: 1; margin-right: 10px; font-size: 0.9em; }

         .delete-payment-btn {
             background-color: transparent; color: #dc3545; border: 1px solid #dc3545;
             border-radius: 3px; padding: 1px 4px; font-size: 0.8em; cursor: pointer;
             margin-left: 10px; flex-shrink: 0; margin: 0;
         }
         .delete-payment-btn:hover { background-color: #dc3545; color: white; }
         html.dark .delete-payment-btn { border-color:var(--danger-color-dark); color:var(--danger-color-dark); }
         html.dark .delete-payment-btn:hover { background-color:var(--danger-color-dark); color:var(--background-color); }

         #addPaymentForm {
             margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);
             display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
         }
         #addPaymentForm label { font-size: 0.9em; }
         #addPaymentForm input[type="number"],
         #addPaymentForm input[type="date"], /* Added for potential future use */
         #addPaymentForm input[type="text"] {
             flex-grow: 1; min-width: 100px; margin: 0;
        }
          @media (min-width: 640px) {
              #addPaymentForm input[type="number"],
              #addPaymentForm input[type="date"],
              #addPaymentForm input[type="text"] {
                  flex-grow: 0;
                  width: auto;
                  min-width: unset;
              }
              #addPaymentForm input[type="number"] { width: 80px;}
              #addPaymentForm input[type="text"] { width: 150px;}
        }

         #addPaymentForm button {
             margin: 0; padding: 6px 12px; font-size: 1em;
             border-color: var(--primary-color); color: var(--primary-color); background-color: transparent; width: 100%;
        }
          @media (min-width: 640px) { #addPaymentForm button { width: auto; flex-grow: 0; } }

        #addPaymentForm button:hover { background-color: var(--primary-color); color: white; }
        html.dark #addPaymentForm button { border-color:var(--primary-color-dark); color:var(--primary-color-dark); }
        html.dark #addPaymentForm button:hover { background-color:var(--primary-color-dark); color:var(--background-color); }

        #controlsHeader {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);
        }
        #appTitle { margin: 0; font-size: 1.5em; }
        #topControls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap;}
        #topControls button { margin: 0; padding: 4px 6px; font-size: 0.9em; }

        .control-icon { font-size: 1.2em; border: none; background: none; padding: 0; margin: 0; color: var(--text-color); }
        .control-icon:hover { color: var(--input-placeholder); background: none; border: none; }
        html.dark .control-icon {color:var(--text-color);} html.dark .control-icon:hover {color:var(--input-placeholder);}

        #quickMonthChangeBtn { border: none; background: none; padding: 0; margin: 0; font-size: 1.2em; cursor: pointer; color: var(--primary-color); }
        #quickMonthChangeBtn:hover { color: var(--link-color); }
        html.dark #quickMonthChangeBtn {color:var(--primary-color-dark);} html.dark #quickMonthChangeBtn:hover {color:var(--link-color);}

        .current-day-row { background-color: var(--current-day-bg); }

        #reminderArea {
             margin-top: 10px; padding: 8px;
             background-color: var(--reminder-bg); color: var(--reminder-text);
             border-radius: 4px; font-size: 0.9em; display: none;
         }
         hr { border-color: var(--border-color); }

        .friday-row { background-color: var(--friday-bg-light); }
        .friday-row td { border-color: var(--friday-border-light) !important; }
        .sunday-row { background-color: var(--sunday-bg-light); }
        .sunday-row td { border-color: var(--sunday-border-light) !important; }

        html.dark .friday-row { background-color: var(--friday-bg-dark); }
        html.dark .friday-row td { border-color: var(--friday-border-dark) !important; }
        html.dark .sunday-row { background-color: var(--sunday-bg-dark); }
        html.dark .sunday-row td { border-color: var(--sunday-border-dark) !important; }

        .current-day-row.friday-row,
        .current-day-row.sunday-row {
            background-color: var(--current-day-bg) !important;
        }

        #saveStatusIndicator {
            position: fixed; top: 10px; right: 10px;
            padding: 5px 10px; border-radius: 4px;
            font-size: 0.9em; z-index: 2000;
            display: none;
            transition: opacity 0.5s ease-out, background-color 0.3s ease;
            background-color: var(--save-success-bg);
            color: var(--save-text-color);
        }
        #saveStatusIndicator.saving {
            background-color: var(--save-saving-bg);
            color: var(--text-color);
        }
        html.dark #saveStatusIndicator.saving {
            color: var(--background-color);
        }
        #saveStatusIndicator.error {
            background-color: var(--save-error-bg);
        }

        tfoot tr td {
            font-weight: bold;
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }
        html.dark tfoot tr td {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }

    </style>
</head>
<body class="">
    <div id="saveStatusIndicator"></div>

     <div id="controlsHeader">
         <h1 id="appTitle" data-translate-key="appTitle">Attendance Tracker</h1>
         <div id="topControls">
             <button id="languageToggleBtn" onclick="toggleLanguage()" class="control-icon" data-translate-key-title="Change Language / भाषा बदलें">
                 <i class="fas fa-language"></i> <span id="currentLangDisplay"></span>
             </button>
             <button id="darkModeToggleBtn" onclick="toggleDarkMode()" class="control-icon" data-translate-key-title="Toggle Dark Mode / डार्क मोड टॉगल करें">
                 <i class="fas fa-moon"></i>
             </button>
             <button id="hideUsersBtn" onclick="toggleUsers()">
                 <span data-translate-key="hideShowNames">Hide/Show Names</span>
             </button>
             <button id="toggleDataManagementBtn" onclick="toggleDataMenu()" class="control-icon" data-translate-key-title="Data Management Options / डेटा प्रबंधन विकल्प">
                 <i class="fas fa-database"></i> </button>
         </div>
     </div>

    <div id="addUserInputContainer" class="container">
         <input type="text" id="newUserName" data-translate-key-placeholder="addNewNamePlaceholder" placeholder="Add New Name" style="flex-grow: 1;"> <button id="addUserBtn" onclick="addUser()">
            <span style="font-size: 20px;">➕</span>
         </button>
    </div>

    <div id="userTabs"></div>
    <div id="reminderArea"></div> <div id="dataManagementButtons"> <button id="exportDataBtn" onclick="exportData()" >
            <i class="fas fa-download"></i> <span data-translate-key="exportData">Export Data (JSON)</span>
        </button>
        <button id="importDataBtn" onclick="document.getElementById('importFileInput').click()" >
            <i class="fas fa-upload"></i> <span data-translate-key="importData">Import Data (JSON)</span>
        </button>
        <input type="file" id="importFileInput" accept=".json" onchange="handleFileUpload(event)" style="display:none;">
        <button id="clearDataBtn" onclick="clearAllData()" >
            <i class="fas fa-trash-alt"></i> <span data-translate-key="clearAllData">Clear All Data</span>
        </button>
        <button id="archiveUserBtn" onclick="toggleArchiveCurrentUser()" style="display: none;"></button> <button id="toggleArchivedUsersBtn" onclick="toggleArchivedUsers()" style="display: none;"></button> </div>

    <div id="importPreviewModal" class="modal">
        <div class="modal-content"> <div class="modal-header"> <span class="modal-title" data-translate-key="importPreviewTitle">Import Data Preview</span>
                <span class="close-button" onclick="closeImportModal()">&times;</span> </div>
            <div class="modal-body" id="importPreviewContent"></div>
            <div class="modal-footer">
                <button onclick="closeImportModal()" data-translate-key="cancel">Cancel</button>
                <button onclick="confirmImport('merge')" data-translate-key="mergeData">Merge Data</button>
                <button onclick="confirmImport('replace')" data-translate-key="replaceAllData">Replace All Data</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span class="modal-title" data-translate-key="notesModalTitle">View/Edit Note</span>
                <span class="close-button" onclick="closeNotesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <textarea id="modalNoteTextarea" rows="6" data-translate-key-placeholder="notesPlaceholder"></textarea>
                <input type="hidden" id="modalNoteMonthKey">
                <input type="hidden" id="modalNoteDayIndex">
            </div>
            <div class="modal-footer">
                <button onclick="closeNotesModal()" data-translate-key="cancel">Cancel</button>
                <button onclick="saveModalNote()" id="saveNoteModalBtn" data-translate-key="saveNote">Save Note</button>
            </div>
        </div>
    </div>


    <div id="userControl"> <div> <h2 style="margin: 0;"><span data-translate-key="forUser">के लिए</span> <span id="selectedUserName"></span></h2>
        </div>

        <div id="userQuickControls">
             <div id="rateContainer">
                 <label for="userRate" data-translate-key="rateLabel">Rate (Per Attendance):</label>
                 <input type="number" id="userRate" min="0" data-translate-key-placeholder="ratePlaceholderShort" placeholder="Rate">
             </div>

             <div id="overtimeRateContainer">
                 <label for="userOvertimeRate" data-translate-key="overtimeRateLabel">Overtime Hours per Attendance Rate:</label>
                 <input type="number" id="userOvertimeRate" min="1" step="0.5" data-translate-key-placeholder="otRatePlaceholderShort" placeholder="OT Rate">
             </div>

              <div id="manualBalanceContainer">
                 <label for="manualCarriedOverBalance" data-translate-key="manualBalanceLabel">Carried Over Balance:</label>
                 <input type="number" id="manualCarriedOverBalance" data-translate-key-placeholder="balancePlaceholderShort" placeholder="Previous Balance">
              </div>

              <div id="includeBalanceContainer">
                  <label for="otherUserForReport" data-translate-key="includeBalanceOf">Include Balance of:</label>
                  <select id="otherUserForReport" onchange="showSummary(activeReportType)">
                      <option value="" selected disabled hidden data-translate-key="selectUserPlaceholderShort">-- User --</option>
                      </select>
              </div>
         </div>


        <div id="monthNavWrapper">
            <div id="monthNav">
                <button onclick="goToPreviousMonth()">❮ <span data-translate-key="previous">Previous</span></button>
                <div class="month-display-group">
                    <span id="currentMonthDisplay"></span>
                    <button id="quickMonthChangeBtn" onclick="promptQuickMonthChange()" title="Quick Change Month">⚡</button>
                </div>
                <button onclick="goToNextMonth()"><span data-translate-key="next">Next</span> ❯</button>
            </div>
        </div>

        <div id="viewReportButtonsWrapper">
            <button onclick="showSummary('firstHalfIndependent')"><span data-translate-key="first15DaysIndie">1-15 (Indie)</span></button>
            <button onclick="showSummary('afterFifteenthIndependent')"><span data-translate-key="after15thIndie">16-End (Indie)</span></button>
            <button onclick="showSummary('firstHalfCurrent')"><span data-translate-key="first15DaysInfo">1-15 (Info)</span></button>
            <button onclick="showSummary('afterFifteenthCurrent')"><span data-translate-key="after15thInfo">16-End (Info)</span></button>
            <button onclick="showSummary('fullMonth')"><span data-translate-key="fullMonth">Full Month</span></button>
            <button id="viewOverallReportBtn" data-translate-key="viewOverallReport" onclick="displayOverallReport()">View Overall Report</button>
        </div>

         <div id="shareReportButtonWrapper">
            <button onclick="shareReport()">
                <span data-translate-key="shareReportImage">Share Report (Image)</span>
             </button>
         </div>
    </div>

     <div id="reportArea">
         <div id="tableContainer"></div>
         <div id="previousBalancePaymentsSection"> <h3 data-translate-key="prevBalancePaymentsTitle">Payments Received Towards Previous Balance</h3>
             <div id="paymentList"></div>
             <div id="addPaymentForm">
                  <label for="paymentAmount" data-translate-key="amountLabel">Amount:</label>
                  <input type="number" id="paymentAmount" data-translate-key-placeholder="amountPlaceholder" placeholder="Amount">
                  <label for="paymentDate" data-translate-key="dateLabel">Date:</label> <!-- Added Date input for payment -->
                  <input type="date" id="paymentDate">
                  <label for="paymentNotes" data-translate-key="notesLabel">Notes:</label>
                  <input type="text" id="paymentNotes" data-translate-key-placeholder="notesPlaceholder" placeholder="Notes">
                  <button onclick="addPreviousBalancePayment()"><span data-translate-key="addPayment">Add Payment</span></button>
             </div>
        </div>

         <div id="overallSummarySection" style="display: none;"></div>

         <div id="summarySection"> </div>

        <div id="reportFooter"> </div>
    </div>

    <script>
        // --- Configuration ---
        const translations = {
             'en': {
                appTitle: "Attendance Tracker", hideShowNames: "Hide/Show Names", dataManagement: "Data Management",
                 dataManagementOptions: "Data Management Options", exportData: "Export Data (JSON)", importData: "Data Import (JSON)",
                 clearAllData: "Clear All Data", chartsTitle: "Charts", forUser: "For", previous: "Previous", next: "Next",
                 // Updated for new report types
                 first15DaysIndie: "1-15 (Calc)", after15thIndie: "16-End (Calc)",
                 first15DaysInfo: "1-15 (Info)", after15thInfo: "16-End (Info)",
                 fullMonth: "Full Month",
                 shareReportImage: "Share Report (Image)", prevBalancePaymentsTitle: "Payments Received Towards Previous Balance",
                 amountLabel: "Amount:", dateLabel: "Date:", notesLabel: "Notes:", addPayment: "Add Payment",
                 cancel: "Cancel", mergeData: "Merge Data", replaceAllData: "Replace All Data", attendanceHeader: "Attendance",
                 expensesHeader: "Expenses", rent: "Rent", food: "Food", received: "Received (Daily)", balance: "Balance",
                 addNewNamePlaceholder: "Add New Name", notesPlaceholder: "Notes", amountPlaceholder: "Amount",
                 promptMonthInput: "Enter Month (YYYY-MM):",
                 dateHeaderTbl: "Date", statusHeaderTbl: "Status", otHeaderTbl: "OT", rentHeaderTbl: "Rent", foodHeaderTbl: "Food", receivedHeaderTbl: "Received", notesHeaderTbl: "Notes", editedHeaderTbl: "Edited",
                 alertEnterName: "Please enter a name.", alertUserExists: "User '{name}' already exists (case-insensitive match)! Do you want to reactivate them?",
                 alertUserAdded: "User '{name}' added successfully!", alertSelectUserMonth: "Please select a user and month first.",
                 alertEnterValidAmount: "Please enter a valid positive amount.", alertPaymentAdded: "Payment added.", alertPaymentDeleted: "Payment deleted.",
                 confirmDeletePayment: "Are you sure you want to delete this payment of {amount}?",
                 alertGenerateReportFirst: "Please generate a report first by clicking one of the 'View Report' buttons.",
                 alertCannotGenerateImage: "Cannot generate report image without a selected user, month, or table data.",
                 alertWebShareFailed: "Sharing failed directly. Report image downloaded instead.", alertWebShareCancelled: "Web Share cancelled by user.",
                 alertImageDownloaded: "Report image generated. It should be downloaded to your device.", alertCouldNotGenerateImage: "Could not generate report image.",
                 confirmClearData: "Are you sure you want to delete ALL user data? This action cannot be undone.",
                 alertDataCleared: "All data has been cleared.", alertDataExported: "Data exported successfully! Your backup file is being downloaded.",
                 alertExportFailed: "Failed to export data. Error: {error}", alertNoFileSelected: "No file selected.",
                 alertSelectJsonFile: "Please select a JSON file.", alertImportProcessingError: "Failed to process import file: {error}",
                 alertFileReadError: "Error reading file.", alertInvalidImportFormat: "Invalid data format. Missing attendanceData object.",
                 alertNoImportData: "No import data available.", alertDataImported: "Data {mode} successfully!",
                 alertImportFailed: "Failed to import data: {error}", importPreviewTitle: "Data Import Preview",
                 importContainsUsers: "This data file contains information for <strong>{count}</strong> users:",
                 andMoreUsers: "...and {count} more users", currentData: "Current Data:",
                 youHaveUsers: "You currently have <strong>{count}</strong> users in your system.",
                 importChooseOption: "Please choose how to import this data:",
                 importOptionMerge: "Merge Data: Add new users and update existing ones",
                 importOptionReplace: "Replace All: Delete all current data and replace with imported data",
                 reportFor: "Report for {user} - {title}",
                 attendanceSummary: "Attendance: {days} days × {rate} = {total}",
                 overtimeSummary: "Overtime: {hours} hours → {amount} ({hoursPerDay} hours equals 1 Attendance Rate)",
                 rentSummary: "Rent: {amount}", foodSummary: "Food: {amount}", currentPeriodGross: "Current Period Gross Total: {amount}",
                 carriedOverBalance: "Carried Over Balance: {amount}", // Simplified, context added in JS
                 manualBalanceLabel: "Carried Over Balance:", manualBalancePlaceholder: "Enter Previous Balance",
                 totalOwed: "Total Amount Owed (Gross + Carried Over Balance): {amount}",
                 totalReceivedDaily: "Total Received (Daily Entries this Period): {amount}",
                 totalReceivedPrevBalance: "Total Received (Towards Previous Balance this Period): {amount}",
                 totalAllReceived: "Total ALL Received (This Period): {amount}",
                 finalBalanceDue: "Final Balance Due: {amount}", // Context (Period/Full Month) added in JS
                 finalBalanceDueForPeriod: "Final Balance Due (This Period): {amount}",
                 finalBalanceDueFullMonthContext: "Final Balance Due (Full Month Context): {amount}",
                 reportTitleFull: "{year} {month} ({days} days) Report",
                 reportTitleFirstHalf: "{year} {month} First {days} Days Report",
                 reportTitleAfterFifteenth: "{year} {month} Report After 15th ({days} days)",
                 reportGeneratedOn: "Report for {user} ({monthYear}{periodType}) - Generated on {dateTime}\nFinal Balance Due: {balance}{otherUserBalanceString}",
                 reportPeriodFullMonth: " (Full Month)",
                 reportPeriodFirstHalfIndie: " (1-15, Calc)", reportPeriodAfter15thIndie: " (16-End, Calc)",
                 reportPeriodFirstHalfInfo: " (1-15, Info)", reportPeriodAfter15thInfo: " (16-End, Info)",
                 reminderFinalize: "Month is ending soon. Remember to finalize reports.",
                 noPaymentsRecorded: "no payments recorded for this period.", noDataForMonth: "No or invalid data structure available for {monthKey}.",
                 pleaseSelectUser: "Please select a user first.", errorInvalidMonthKey: "Error: Invalid month data key \"{monthKey}\".",
                 invalidMonth: "Invalid Month", alertInvalidMonthFormat: "Invalid month format. Please use YYYY-MM (e.g., 2023-10).",
                 alertInvalidDateTimeFormat: "Invalid date/time format. Please use DD-MM-YYYY and HH:MM or leave empty.",
                 alertMonthDoesNotExist: "No data available for month {monthKey}.", noDate: "No Date/Time", autoSaveStatus: "Auto-saved: {time}",
                 confirmArchiveUser: "Are you sure you want to archive user '{name}'? Their data will be saved but they won't appear in the main list until you click 'Show Archived Users'.",
                 alertUserArchived: "User '{name}' has been archived. You can see them by clicking 'Show Archived Users'.",
                 confirmReactivateUser: "User '{name}' is currently archived. Do you want to reactivate them?",
                 alertUserReactivated: "User '{name}' has been reactivated.", showOptions: "Show Options", hideOptions: "Hide Options",
                 showArchived: "Show Archived", hideArchived: "Hide Archived", archiveUser: "Archive User", reactivateUser: "Reactivate User",
                 cannotGoToFutureMonth: "Cannot navigate to a future month relative to the current system date.",
                 confirmCarryOverBalance: "Do you want to carry over the balance of {amount} to month {month}?",
                 viewOverallReport: "View Overall Report", overallReportTitle: "Overall Report for {user}",
                 overallAttendanceSummary: "Total Attendance Days: {days}", overallOvertimeSummary: "Total Overtime Hours: {hours}",
                 overallRentSummary: "Total Rent: {amount}", overallFoodSummary: "Total Food: {amount}",
                 overallDailyReceivedSummary: "Total Daily Received: {amount}", overallPrevBalPaymentsSummary: "Total Received Towards Previous Balance: {amount}",
                 overallGrossSummary: "Total Gross Earnings: {amount}", initialCarriedOverBalanceSummary: "Initial Carried Over Balance (from {month}): {amount}",
                 overallFinalBalanceDue: "Overall Final Balance Due: {amount}", noDataForOverallReport: "No data available to generate overall report for {user}.",
                 includeBalanceOf: "Include Balance of:", otherUserPeriodEarnings: "Period Earnings for {otherUser}: {amount}",
                 otherUserPeriodReceived: "Period Received (Daily) for {otherUser}: {amount}", otherUserPeriodNet: "Period Net for {otherUser} ({earnings} - {received}): {amount}",
                 otherUserFinalBalance: "Final Balance Due for {otherUser}: {amount}", combinedFinalBalance: "Combined Final Balance Due ({currentUser} + {otherUser}'s Final Balance): {amount}",
                 footerIncludeOtherUserFinalBalance: "\n(Including {otherUser}'s Final Balance: {otherUserFinalBalance}) \nCombined Balance: {combinedBalance}",
                 overtimeRateLabel: "Overtime Hours per Attendance Rate:", otRatePlaceholder: "OT Rate", selectUserPlaceholder: "-- Select User --",
                 ratePlaceholderShort: "Rate", otRatePlaceholderShort: "OT", balancePlaceholderShort: "Bal", selectUserPlaceholderShort: "-- User --",
                 editedDatePlaceholder: "DD-MM-YYYY", editedTimePlaceholder: "HH:MM",
                 notesModalTitle: "View/Edit Note", saveNote: "Save Note", totalLabel: "Total",
                 alertPaymentDateRequired: "Please select a date for the payment.",
                 carriedOverBalanceFromPrevMonth: "Carried Over Balance (from Previous Month): {amount}",
                 carriedOverBalanceFromPrevPeriod: "Carried Over Balance (from 1-15 Period): {amount}",

            },
             'hi': {
                appTitle: "हाज़िरी ट्रैकर", hideShowNames: "नाम छिपाएँ/दिखाएँ", dataManagement: "डेटा प्रबंधन",
                 dataManagementOptions: "डेटा प्रबंधन विकल्प", exportData: "डेटा एक्सपोर्ट करें (JSON)", importData: "डेटा इम्पोर्ट करें (JSON)",
                 clearAllData: "सारा डेटा साफ़ करें", chartsTitle: "चार्ट", forUser: "के लिए", previous: "पिछला", next: "अगला",
                 // Updated for new report types - Hindi
                 first15DaysIndie: "1-15 (गणना)", after15thIndie: "16-अंत (गणना)",
                 first15DaysInfo: "1-15 (जानकारी)", after15thInfo: "16-अंत (जानकारी)",
                 fullMonth: "पूरा महीना",
                 shareReportImage: "रिपोर्ट शेयर करें (इमेज)", prevBalancePaymentsTitle: "पिछले बैलेंस के लिए प्राप्त भुगतान",
                 amountLabel: "राशि:", dateLabel: "तारीख:", notesLabel: "टिप्पणियाँ:", addPayment: "भुगतान जोड़ें",
                 cancel: "रद्द करें", mergeData: "डेटा मर्ज करें", replaceAllData: "सारा डेटा बदलें", attendanceHeader: "हाज़िरी",
                 expensesHeader: "खर्च", rent: "किराया", food: "खाना", received: "प्राप्त (रोजाना)", balance: "बैलेंस",
                 addNewNamePlaceholder: "नया नाम जोड़ें", notesPlaceholder: "टिप्पणियाँ", amountPlaceholder: "राशि",
                 promptMonthInput: "महीना दर्ज करें (YYYY-MM):",
                 dateHeaderTbl: "तारीख", statusHeaderTbl: "स्थिति", otHeaderTbl: "ओटी", rentHeaderTbl: "किराया", foodHeaderTbl: "खाना", receivedHeaderTbl: "प्राप्त", notesHeaderTbl: "टिप्पणियाँ", editedHeaderTbl: "संपादित",
                 alertEnterName: " कृपया एक नाम दर्ज करें।", alertUserExists: "यूज़र '{name}' पहले से मौजूद है! क्या आप उन्हें फिर से सक्रिय करना चाहते हैं?",
                 alertUserAdded: "यूज़र '{name}' सफलतापूर्वक जोड़ा गया!", alertSelectUserMonth: "कृपया पहले एक यूज़र और महीना चुनें।",
                 alertEnterValidAmount: " कृपया एक मान्य सकारात्मक राशि दर्ज करें।", alertPaymentAdded: "भुगतान जोड़ा गया।", alertPaymentDeleted: " भुगतान हटाया गया।",
                 confirmDeletePayment: "क्या आप निश्चित हैं कि आप {amount} का यह भुगतान हटाना चाहते हैं?",
                 alertGenerateReportFirst: "कृपया पहले 'रिपोर्ट देखें' बटनों में से किसी एक पर क्लिक करके रिपोर्ट जनरेट करें।",
                 alertCannotGenerateImage: "चुने हुए यूज़र, महीने, या तालिका डेटा के बिना रिपोर्ट इमेज जनरेट नहीं की जा सकती।",
                 alertWebShareFailed: "सीधा शेयर विफल रहा। रिपोर्ट इमेज इसके बजाय डाउनलोड की गई।", alertWebShareCancelled: "यूज़र द्वारा वेब शेयर रद्द किया गया।",
                 alertImageDownloaded: "रिपोर्ट इमेज जनरेट की गई। इसे आपके डिवाइस पर डाउनलोड होना चाहिए।", alertCouldNotGenerateImage: "रिपोर्ट इमेज जनरेट नहीं हो सकी।",
                 confirmClearData: "क्या आप निश्चित हैं कि आप **सारा** यूज़र डेटा हटाना चाहते हैं? यह कार्रवाई पूर्ववत नहीं की जा सकती।",
                 alertDataCleared: "सारा डेटा साफ़ कर दिया गया है।", alertDataExported: "डेटा सफलतापूर्वक एक्सपोर्ट किया गया! आपकी बैकअप फ़ाइल डाउनलोड हो रही है।",
                 alertExportFailed: "डेटा एक्सपोर्ट विफल रहा: त्रुटि: {error}", alertNoFileSelected: "कोई फ़ाइल नहीं चुनी गई।",
                 alertSelectJsonFile: "कृपया एक JSON फ़ाइल चुनें।", alertImportProcessingError: "इम्पोर्ट फ़ाइल को प्रोसेस करने में विफल रहा: {error}",
                 alertFileReadError: "फ़ाइल पढ़ने में त्रुटि।", alertInvalidImportFormat: "अमान्य डेटा प्रारूप। attendanceData ऑब्जेक्ट गायब है।",
                 alertNoImportData: "कोई इम्पोर्ट डेटा उपलब्ध नहीं है।", alertDataImported: "डेटा सफलतापूर्वक {mode} किया गया!",
                 alertImportFailed: "डेटा इम्पोर्ट विफल रहा: त्रुटि: {error}", importPreviewTitle: "डेटा इम्पोर्ट पूर्वावलोकन",
                 importContainsUsers: "इस डेटा फ़ाइल में <strong>{count}</strong> यूज़र की जानकारी है:",
                 andMoreUsers: "...और {count} अन्य यूज़र", currentData: "वर्तमान डेटा:",
                 youHaveUsers: "आपके सिस्टम में वर्तमान में <strong>{count}</strong> यूज़र हैं।",
                 importChooseOption: "कृपया चुनें कि इस डेटा को कैसे इम्पोर्ट करें:",
                 importOptionMerge: "डेटा मर्ज करें: नए यूज़र जोड़ें और मौजूदा यूज़र को अपडेट करें",
                 importOptionReplace: "सब बदलें: वर्तमान सारा डेटा हटाएँ और इम्पोर्ट किए गए डेटा से बदलें",
                 reportFor: "{user} के लिए रिपोर्ट - {title}",
                 attendanceSummary: "हाज़िरी: {days} दिन × {rate} = {total}",
                 overtimeSummary: "ओवरटाइम: {hours} घंटे → {amount} ({hoursPerDay} घंटे 1 हाज़िरी दर के बराबर)",
                 rentSummary: "किराया: {amount}", foodSummary: "खाना: {amount}", currentPeriodGross: "वर्तमान अवधि का सकल योग: {amount}",
                 carriedOverBalance: "लाया गया बैलेंस: {amount}", // सरलीकृत
                 manualBalanceLabel: "लाया गया बैलेंस:", manualBalancePlaceholder: "पिछला बैलेंस दर्ज करें",
                 totalOwed: "कुल देय राशि (सकल + लाया गया बैलेंस): {amount}",
                 totalReceivedDaily: "कुल प्राप्त (इस अवधि की रोज़ाना प्रविष्टियाँ): {amount}",
                 totalReceivedPrevBalance: "कुल प्राप्त (इस अवधि में पिछले बैलेंस के लिए): {amount}",
                 totalAllReceived: "कुल सभी प्राप्त (इस अवधि): {amount}",
                 finalBalanceDue: "अंतिम देय बैलेंस: {amount}", // संदर्भ JS में जोड़ा जाएगा
                 finalBalanceDueForPeriod: "अंतिम देय बैलेंस (इस अवधि के लिए): {amount}",
                 finalBalanceDueFullMonthContext: "अंतिम देय बैलेंस (पूरे महीने का संदर्भ): {amount}",
                 reportTitleFull: "{year} {month} ({days} दिन) रिपोर्ट",
                 reportTitleFirstHalf: "{year} {month} के पहले {days} दिन की रिपोर्ट",
                 reportTitleAfterFifteenth: "{year} {month} की 15 तारीख के बाद की रिपोर्ट ({days} दिन)",
                 reportGeneratedOn: "{user} के लिए रिपोर्ट ({monthYear}{periodType}) - {dateTime} को जनरेट की गई\nअंतिम देय बैलेंस: {balance}{otherUserBalanceString}",
                 reportPeriodFullMonth: " (पूरा महीना)",
                 reportPeriodFirstHalfIndie: " (1-15, गणना)", reportPeriodAfter15thIndie: " (16-अंत, गणना)",
                 reportPeriodFirstHalfInfo: " (1-15, जानकारी)", reportPeriodAfter15thInfo: " (16-अंत, जानकारी)",
                 reminderFinalize: "महीना जल्द ही समाप्त हो रहा है। रिपोर्ट को अंतिम रूप देना याद रखें।",
                 noPaymentsRecorded: "इस अवधि के लिए कोई भुगतान दर्ज नहीं किया गया।", noDataForMonth: "{monthKey} के लिए कोई या अमान्य डेटा संरचना उपलब्ध नहीं है।",
                 pleaseSelectUser: "कृपया पहले एक यूज़र चुनें।", errorInvalidMonthKey: "त्रुटि: अमान्य महीना डेटा कुंजी \"{monthKey}\"।",
                 invalidMonth: "अमान्य महीना", alertInvalidMonthFormat: "अमान्य महीना प्रारूप। कृपया YYYY-MM (जैसे, 2023-10) का उपयोग करें।",
                 alertInvalidDateTimeFormat: "अमान्य तारीख/समय प्रारूप। कृपया DD-MM-YYYY और HH:MM का उपयोग करें या खाली छोड़ दें।",
                 alertMonthDoesNotExist: "महीना {monthKey} के लिए कोई डेटा उपलब्ध नहीं है।", noDate: "कोई तारीख/समय नहीं", autoSaveStatus: "ऑटो-सेव हुआ: {time}",
                 confirmArchiveUser: "क्या आप निश्चित हैं कि आप यूज़र '{name}' को संग्रहित (archive) करना चाहते हैं? उनका डेटा सहेजा जाएगा लेकिन जब तक आप 'संग्रहित यूज़र दिखाएँ' पर क्लिक नहीं करते, वे मुख्य सूची में दिखाई नहीं देंगे।",
                 alertUserArchived: "यूज़र '{name}' को संग्रहित कर दिया गया है। आप उन्हें 'संग्रहित यूज़र दिखाएँ' पर क्लिक करके देख सकते हैं।",
                 confirmReactivateUser: "यूज़र '{name}' वर्तमान में संग्रहित है। क्या आप उन्हें फिर से सक्रिय करना चाहते हैं?",
                 alertUserReactivated: "यूज़र '{name}' को फिर से सक्रिय कर दिया गया है।", showOptions: "विकल्प दिखाएँ", hideOptions: "विकल्प छिपाएँ",
                 showArchived: "संग्रहित दिखाएँ", hideArchived: "संग्रहित छिपाएँ", archiveUser: "यूज़र संग्रहित करें", reactivateUser: "यूज़र फिर से सक्रिय करें",
                 cannotGoToFutureMonth: "सिस्टम की वर्तमान तारीख से भविष्य के महीने में नहीं जा सकते।",
                 confirmCarryOverBalance: "क्या आप {amount} का बैलेंस {month} महीने में ले जाना चाहते हैं?",
                 viewOverallReport: "कुल रिपोर्ट देखें", overallReportTitle: "{user} के लिए कुल रिपोर्ट",
                 overallAttendanceSummary: "कुल उपस्थिति दिन: {days}", overallOvertimeSummary: "कुल ओवरटाइम घंटे: {hours}",
                 overallRentSummary: "कुल किराया: {amount}", overallFoodSummary: "कुल खाना: {amount}",
                 overallDailyReceivedSummary: "कुल प्राप्त (रोजाना): {amount}", overallPrevBalPaymentsSummary: "पिछले बैलेंस के लिए प्राप्त कुल भुगतान: {amount}",
                 overallGrossSummary: "कुल सकल कमाई: {amount}", initialCarriedOverBalanceSummary: "शुरुआती लाया गया बैलेंस ({month} से): {amount}",
                 overallFinalBalanceDue: "कुल अंतिम बैलेंस देय: {amount}", noDataForOverallReport: "{user} के लिए कुल रिपोर्ट जनरेट करने के लिए कोई डेटा उपलब्ध नहीं है।",
                 includeBalanceOf: "शामिल करें बैलेंस किसका:", otherUserPeriodEarnings: "पीरियड कमाई {otherUser} के लिए: {amount}",
                 otherUserPeriodReceived: "पीरियड प्राप्त (रोजाना) {otherUser} के लिए: {amount}", otherUserPeriodNet: "पीरियड नेट {otherUser} के लिए ({earnings} - {received}): {amount}",
                 otherUserFinalBalance: "{otherUser} का अंतिम देय बैलेंस: {amount}", combinedFinalBalance: "संयुक्त अंतिम देय बैलेंस ({currentUser} + {otherUser} का अंतिम बैलेंस): {amount}",
                 footerIncludeOtherUserFinalBalance: "\n({otherUser} का अंतिम बैलेंस शामिल है: {otherUserFinalBalance}) \nसंयुक्त बैलेंस: {combinedBalance}",
                 overtimeRateLabel: "ओवरटाइम घंटे प्रति हाज़िरी दर:", otRatePlaceholder: "ओटी दर", selectUserPlaceholder: "-- यूज़र चुनें --",
                 ratePlaceholderShort: "दर", otRatePlaceholderShort: "ओटी", balancePlaceholderShort: "बैलेंस", selectUserPlaceholderShort: "-- यूज़र चुनें --",
                 editedDatePlaceholder: "DD-MM-YYYY", editedTimePlaceholder: "HH:MM",
                 notesModalTitle: "नोट देखें/संपादित करें", saveNote: "नोट सहेजें", totalLabel: "कुल",
                 alertPaymentDateRequired: "कृपया भुगतान के लिए एक तारीख चुनें।",
                 carriedOverBalanceFromPrevMonth: "लाया गया बैलेंस (पिछले महीने से): {amount}",
                 carriedOverBalanceFromPrevPeriod: "लाया गया बैलेंस (1-15 अवधि से): {amount}",
            }
        };
        let currentLanguage = localStorage.getItem('appLanguage') || 'hi';
        let data = {};
        let currentUser = null;
        let currentlyViewedMonth = null;
        let activeReportType = 'fullMonth'; // Default report type, will be overridden by localStorage if available
        let finalBalanceForReport = 0;
        let combinedFinalBalanceForReport = 0;
        let otherUserFinalBalanceForReport = 0;
        let importDataBuffer = null;
        let showArchivedUsers = false;

        const RENDER_DELAY = 350;
        let renderTimeout = null;
        let saveStatusTimeout = null;

        function translate(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
             for (const param in params) {
                 text = text.replace(new RegExp(`{${param}}`, 'g'), params[param]);
             }
             return text;
        }

        function applyTranslationsToUI() {
             document.querySelectorAll('[data-translate-key]').forEach(element => {
                 element.textContent = translate(element.getAttribute('data-translate-key'));
             });
             document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                  element.placeholder = translate(element.getAttribute('data-translate-key-placeholder'));
             });
              document.querySelectorAll('[data-translate-key-title]').forEach(element => {
                  element.title = translate(element.getAttribute('data-translate-key-title'));
             });
             const hideUsersBtn = document.getElementById('hideUsersBtn');
             if (hideUsersBtn) {
                  hideUsersBtn.querySelector('span').textContent = translate('hideShowNames');
             }
              const langDisplay = document.getElementById('currentLangDisplay');
              if (langDisplay) langDisplay.textContent = currentLanguage.toUpperCase();

              const tableHead = document.querySelector('#tableContainer thead tr');
               if (tableHead) {
                    const headers = tableHead.querySelectorAll('th');
                    if(headers.length >= 8) {
                        headers[0].textContent = translate('dateHeaderTbl');
                        headers[1].textContent = translate('statusHeaderTbl');
                        headers[2].textContent = translate('otHeaderTbl');
                        headers[3].textContent = translate('rentHeaderTbl');
                        headers[4].textContent = translate('foodHeaderTbl');
                        headers[5].textContent = translate('receivedHeaderTbl');
                        headers[6].textContent = translate('notesHeaderTbl');
                        headers[7].textContent = translate('editedHeaderTbl');
                    }
               }
               updateMonthDisplay();

                const archiveUserBtn = document.getElementById('archiveUserBtn');
                if (archiveUserBtn && currentUser && data[currentUser]) {
                    const isArchived = data[currentUser].isActive === false;
                    archiveUserBtn.textContent = translate(isArchived ? 'reactivateUser' : 'archiveUser');
                    archiveUserBtn.className = '';
                    archiveUserBtn.classList.add(isArchived ? 'reactivate-style' : 'archive-style');
                } else if (archiveUserBtn) {
                     archiveUserBtn.style.display = 'none';
                }

                const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
                if (toggleArchivedBtn) {
                    toggleArchivedBtn.textContent = showArchivedUsers ? translate('hideArchived') : translate('showArchived');
                }

                 const rateLabel = document.querySelector('label[for="userRate"]');
                 if (rateLabel) rateLabel.textContent = translate('rateLabel');
                 const overtimeRateLabel = document.querySelector('label[for="userOvertimeRate"]');
                 if(overtimeRateLabel) overtimeRateLabel.textContent = translate('overtimeRateLabel');
                 const manualBalanceLabel = document.querySelector('label[for="manualCarriedOverBalance"]');
                 if (manualBalanceLabel) manualBalanceLabel.textContent = translate('manualBalanceLabel');
                 const includeBalanceLabel = document.querySelector('label[for="otherUserForReport"]');
                 if(includeBalanceLabel) includeBalanceLabel.textContent = translate('includeBalanceOf');
                 const selectPlaceholderOption = document.querySelector('#otherUserForReport option[disabled][hidden]');
                 if(selectPlaceholderOption) selectPlaceholderOption.textContent = translate('selectUserPlaceholderShort');

                 const importPreviewTitle = document.querySelector('#importPreviewModal .modal-title');
                 if(importPreviewTitle) importPreviewTitle.textContent = translate('importPreviewTitle');

                 const notesModalTitleEl = document.querySelector('#notesModal .modal-title[data-translate-key="notesModalTitle"]');
                 if(notesModalTitleEl) {
                    const currentText = notesModalTitleEl.textContent;
                    if (!currentText.includes(" - ") || currentText.startsWith(translations[currentLanguage === 'en' ? 'hi' : 'en']['notesModalTitle'])) {
                         notesModalTitleEl.textContent = translate('notesModalTitle');
                    }
                 }

                document.querySelectorAll('.edited-date-input').forEach(el => el.placeholder = translate('editedDatePlaceholder'));
                document.querySelectorAll('.edited-time-input').forEach(el => el.placeholder = translate('editedTimePlaceholder'));
                const saveNoteModalBtn = document.getElementById('saveNoteModalBtn');
                if (saveNoteModalBtn) saveNoteModalBtn.textContent = translate('saveNote');
                const notesModalCancelBtn = document.querySelector('#notesModal .modal-footer button[onclick="closeNotesModal()"]');
                if (notesModalCancelBtn) notesModalCancelBtn.textContent = translate('cancel');
                const notesTextarea = document.getElementById('modalNoteTextarea');
                if (notesTextarea) notesTextarea.placeholder = translate('notesPlaceholder');

                const totalLabelCell = document.querySelector('#tableFooterRow td[data-translate-key="totalLabel"]');
                if(totalLabelCell) totalLabelCell.textContent = translate('totalLabel');
        }

        function toggleLanguage() {
            currentLanguage = (currentLanguage === 'en') ? 'hi' : 'en';
            localStorage.setItem('appLanguage', currentLanguage);
            document.documentElement.lang = currentLanguage;
            applyTranslationsToUI();
             scheduleFullRender(100);
        }
        function setDarkMode(isDark) {
            const htmlElement = document.documentElement;
             const toggleIcon = document.getElementById('darkModeToggleBtn')?.querySelector('i');
             if (isDark) {
                 htmlElement.classList.add('dark');
                 localStorage.setItem('darkMode', 'enabled');
                 if(toggleIcon) { toggleIcon.classList.remove('fa-moon'); toggleIcon.classList.add('fa-sun'); }
             } else {
                 htmlElement.classList.remove('dark');
                 localStorage.setItem('darkMode', 'disabled');
                 if(toggleIcon) { toggleIcon.classList.remove('fa-sun'); toggleIcon.classList.add('fa-moon'); }
             }
              scheduleFullRender(100);
        }
        function toggleDarkMode() { setDarkMode(!document.documentElement.classList.contains('dark')); }
        if (localStorage.getItem('darkMode') === 'enabled') setDarkMode(true); else setDarkMode(false);

        function checkReminders() {
            const reminderDiv = document.getElementById('reminderArea');
              if (!reminderDiv) return;
              if (!currentUser || (data[currentUser] && data[currentUser].isActive === false)) {
                  reminderDiv.style.display = 'none'; return;
              }
              if (!currentlyViewedMonth) { reminderDiv.style.display = 'none'; return; }
              const [year, monthNum] = currentlyViewedMonth.split('-').map(Number);
              const today = new Date();
              const currentSystemYear = today.getFullYear();
              const currentSystemMonth = today.getMonth() + 1;

              if (year === currentSystemYear && monthNum === currentSystemMonth) {
                  const endOfMonth = new Date(year, monthNum, 0).getDate();
                  const currentDayOfMonth = today.getDate();
                  if (endOfMonth - currentDayOfMonth <= 3 && endOfMonth - currentDayOfMonth >= 0) {
                       reminderDiv.textContent = translate('reminderFinalize');
                       reminderDiv.style.display = 'block';
                   } else {
                       reminderDiv.style.display = 'none';
                   }
              } else {
                  reminderDiv.style.display = 'none';
              }
        }

        function fullRender() {
             const userControl = document.getElementById("userControl");
             const tableContainer = document.getElementById("tableContainer");
             const monthlySummarySection = document.getElementById("summarySection");
             const overallSummarySection = document.getElementById("overallSummarySection");
             const paymentsSection = document.getElementById('previousBalancePaymentsSection');
             const footerDiv = document.getElementById('reportFooter');
             const quickChange = document.getElementById('quickMonthChangeBtn');
             const userQuickControls = document.getElementById('userQuickControls');


             if (!currentUser || !currentlyViewedMonth || !data[currentUser]) {
                 userControl.style.display = "none";
                 tableContainer.innerHTML = "";
                 monthlySummarySection.innerHTML = "";
                 monthlySummarySection.style.display = 'none';
                 overallSummarySection.innerHTML = "";
                 overallSummarySection.style.display = 'none';
                 paymentsSection.style.display = 'none';
                 if(footerDiv) footerDiv.textContent = '';
                 document.getElementById('currentMonthDisplay').textContent = '';
                 if(quickChange) quickChange.style.display = 'none';
                 if(userQuickControls) userQuickControls.style.display = 'none';
                 const dataManagementButtons = document.getElementById('dataManagementButtons');
                 const archiveBtn = document.getElementById('archiveUserBtn');
                 if ((dataManagementButtons.style.display === 'flex' || dataManagementButtons.style.display === 'block') && archiveBtn) {
                     archiveBtn.style.display = 'none';
                 }
                 checkReminders();
                 return;
             }
             userControl.style.display = "block";
             paymentsSection.style.display = 'block';
             if(quickChange) quickChange.style.display = 'inline-block';
             if(userQuickControls) userQuickControls.style.display = 'flex';
             monthlySummarySection.style.display = 'block';
             overallSummarySection.style.display = 'none';

             renderTable(currentlyViewedMonth);
             showSummary(activeReportType);
             checkReminders();
             applyTranslationsToUI();
        }
        function scheduleFullRender(delay = RENDER_DELAY) { if (renderTimeout) clearTimeout(renderTimeout); renderTimeout = setTimeout(fullRender, delay); }

        function showSaveStatus(message, type = 'success', duration = 2000) {
            const indicator = document.getElementById('saveStatusIndicator');
            if (!indicator) return;

            indicator.textContent = message;
            indicator.className = '';
            indicator.style.opacity = '1';
            indicator.style.display = 'block';

            if (type === 'success') { /* Default styles apply */ }
            else if (type === 'saving') indicator.classList.add('saving');
            else if (type === 'error') indicator.classList.add('error');

            if (saveStatusTimeout) clearTimeout(saveStatusTimeout);
            if (duration > 0) {
                saveStatusTimeout = setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => { indicator.style.display = 'none'; }, 500);
                }, duration);
            }
        }

        function loadData() {
            // Load activeReportType from localStorage or set default
            const storedActiveReportType = localStorage.getItem('activeReportType');
            activeReportType = storedActiveReportType || 'fullMonth';

            const storedData = localStorage.getItem('attendanceData');
             if (storedData) {
                 try {
                      data = JSON.parse(storedData);
                       if (typeof data !== 'object' || data === null) data = {};
                       else {
                           let migrationNeeded = false;
                            for(const userName in data) {
                                if(data[userName] && typeof data[userName] === 'object') {
                                    if(data[userName].rate === undefined) { data[userName].rate = 0; migrationNeeded = true; }
                                    if(data[userName].overtimeRate === undefined || typeof data[userName].overtimeRate !== 'number' || data[userName].overtimeRate <= 0) {
                                         data[userName].overtimeRate = 8; migrationNeeded = true;
                                    }
                                    if(data[userName].isActive === undefined) { data[userName].isActive = true; migrationNeeded = true; }
                                    if(data[userName].months === undefined) { data[userName].months = {}; migrationNeeded = true; }

                                    if (data[userName].months && typeof data[userName].months === 'object') {
                                        for(const monthKey in data[userName].months) {
                                            if(data[userName].months[monthKey] && typeof data[userName].months[monthKey] === 'object') {
                                                if(typeof data[userName].months[monthKey].carriedOverBalance !== 'number') { data[userName].months[monthKey].carriedOverBalance = 0; migrationNeeded = true; }
                                                if(!Array.isArray(data[userName].months[monthKey].previousBalancePayments)) { data[userName].months[monthKey].previousBalancePayments = []; migrationNeeded = true; }
                                                else {
                                                    data[userName].months[monthKey].previousBalancePayments.forEach(p => {
                                                        // if (p && typeof p === 'object' && !p.date) { /* migration logic */ }
                                                    });
                                                }
                                                if(!Array.isArray(data[userName].months[monthKey].days)) { data[userName].months[monthKey].days = []; migrationNeeded = true; }
                                                const daysArray = data[userName].months[monthKey].days;
                                                if(Array.isArray(daysArray)) {
                                                     for(let i = 0; i < daysArray.length; i++) {
                                                         let day = daysArray[i];
                                                          if (!day || typeof day !== 'object') {
                                                              day = {}; daysArray[i] = day; migrationNeeded = true;
                                                          }
                                                           if(day.date === undefined) { const [y,m] = monthKey.split('-'); day.date = `${i+1}/${parseInt(m)}/${parseInt(y)}`; migrationNeeded = true; }
                                                           if(day.status === undefined) { day.status = ''; migrationNeeded = true; }
                                                           if(day.overtime === undefined) { day.overtime = 0; migrationNeeded = true; }
                                                           if(day.rent === undefined) { day.rent = 0; migrationNeeded = true; }
                                                           if(day.food === undefined) { day.food = 0; migrationNeeded = true; }
                                                           if(day.received === undefined) { day.received = 0; migrationNeeded = true; }
                                                           if(day.notes === undefined) { day.notes = ''; migrationNeeded = true; }
                                                           if(day.updated === undefined) { day.updated = ''; migrationNeeded = true; }
                                                           if (day.location !== undefined) { delete day.location; migrationNeeded = true; }
                                                     }
                                                }
                                            } else {
                                                 data[userName].months[monthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] }; migrationNeeded = true;
                                            }
                                        }
                                    }
                                } else {
                                     delete data[userName]; migrationNeeded = true;
                                }
                            }
                           if (migrationNeeded) { console.log("Data migration performed."); saveData(); }
                       }
                 } catch (e) { console.error("Error parsing data:", e); alert(translate('alertImportProcessingError', {error: e.message})); data = {}; }
             } else data = {};

             renderUserTabs(); applyTranslationsToUI();
             const lastUser = localStorage.getItem('lastSelectedUser');
             if(lastUser && data[lastUser] && (data[lastUser].isActive !== false || showArchivedUsers)) {
                selectUser(lastUser);
             } else {
                 currentUser = null; currentlyViewedMonth = null; localStorage.removeItem('lastSelectedUser');
                 fullRender();
             }
             checkReminders();
        }
        function saveData() {
            showSaveStatus(translate('autoSaveStatus', {time: 'Saving...'}), 'saving', 0);
            try {
                localStorage.setItem('attendanceData', JSON.stringify(data));
                console.log("Data auto-saved.");
                const now = new Date();
                const timeString = now.toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { hour: '2-digit', minute: '2-digit' });
                showSaveStatus(translate('autoSaveStatus', {time: timeString }), 'success', 2500);
            } catch (e) {
                console.error("Error saving data:", e);
                showSaveStatus("Error saving data!", 'error', 3000);
            }
        }

        function addUser() {
            const nameInput = document.getElementById("newUserName");
             const name = nameInput.value.trim();
             if (!name) { alert(translate('alertEnterName')); return; }

             const existingUserName = Object.keys(data).find(key => key.toLowerCase() === name.toLowerCase());

             if (existingUserName) {
                 const existingUser = data[existingUserName];
                 if (existingUser.isActive === false) {
                      if (confirm(translate('confirmReactivateUser', { name: existingUserName }))) {
                          existingUser.isActive = true; saveData();
                          alert(translate('alertUserReactivated', { name: existingUserName }));
                          nameInput.value = ""; renderUserTabs(); selectUser(existingUserName); return;
                      } else { nameInput.value = ""; return; }
                 } else {
                    alert(translate('alertUserExists', { name: existingUserName }).split('?')[0]);
                    nameInput.value = ""; return;
                 }
             }

             const formattedName = name.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
             data[formattedName] = { rate: 0, overtimeRate: 8, months: {}, isActive: true };
             saveData(); alert(translate('alertUserAdded', {name: formattedName}));
             nameInput.value = ""; renderUserTabs(); selectUser(formattedName);
        }

        function toggleArchiveCurrentUser() {
            if (!currentUser || !data[currentUser]) { return; }
            const user = data[currentUser]; const isArchived = user.isActive === false;
            const confirmAction = isArchived
                ? confirm(translate('confirmReactivateUser', { name: currentUser }))
                : confirm(translate('confirmArchiveUser', { name: currentUser }));

            if (confirmAction) {
                user.isActive = !isArchived; saveData();
                alert(translate(isArchived ? 'alertUserReactivated' : 'alertUserArchived', { name: currentUser }));
                if (!user.isActive && !showArchivedUsers) {
                    currentUser = null; currentlyViewedMonth = null; localStorage.removeItem('lastSelectedUser');
                    fullRender(); renderUserTabs();
                } else {
                    renderUserTabs();
                    selectUser(currentUser);
                }
                const dataManagementButtons = document.getElementById('dataManagementButtons');
                if (dataManagementButtons.style.display === 'flex' || dataManagementButtons.style.display === 'block') {
                    const archiveBtn = document.getElementById('archiveUserBtn');
                    if (archiveBtn) {
                        if (currentUser && data[currentUser]) { archiveBtn.style.display = 'inline-block'; applyTranslationsToUI(); }
                        else { archiveBtn.style.display = 'none'; }
                    }
                 const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
                  if (toggleArchivedBtn) {
                    const hasArchived = Object.values(data).some(u => u.isActive === false);
                    toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
                 }
                }
                 checkReminders();
            }
        }
        function toggleArchivedUsers() {
             showArchivedUsers = !showArchivedUsers; renderUserTabs();
             if (currentUser && data[currentUser]?.isActive === false && !showArchivedUsers) {
                 currentUser = null; currentlyViewedMonth = null; localStorage.removeItem('lastSelectedUser'); fullRender();
             } else if (!currentUser && showArchivedUsers) {
                  const lastUser = localStorage.getItem('lastSelectedUser');
                 if(lastUser && data[lastUser] && data[lastUser].isActive === false) { selectUser(lastUser); }
             }
             const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
             if (toggleArchivedBtn) {
                const hasArchived = Object.values(data).some(u => u.isActive === false);
                toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
             }
             applyTranslationsToUI();
        }

        function populateOtherUserDropdown() {
            const selectElement = document.getElementById('otherUserForReport');
            if (!selectElement) { return; }
            const currentSelectedOtherUser = selectElement.value;
            selectElement.querySelectorAll('option:not([disabled][hidden])').forEach(option => option.remove());
            const activeUserNames = Object.keys(data)
                .filter(name => data[name] && data[name].isActive !== false)
                .sort((a, b) => a.localeCompare(b));
            activeUserNames.forEach(name => {
                if (name !== currentUser) {
                    const option = document.createElement('option'); option.value = name; option.textContent = name;
                    selectElement.appendChild(option);
                }
            });
             if (currentSelectedOtherUser && currentSelectedOtherUser !== currentUser && activeUserNames.includes(currentSelectedOtherUser)) {
                 selectElement.value = currentSelectedOtherUser;
             } else {
                 selectElement.value = "";
             }
        }

        function renderUserTabs() {
             const sortedUserNames = Object.keys(data).sort((a, b) => a.localeCompare(b));
             const tabContainer = document.getElementById("userTabs");
             const hideUsersBtn = document.getElementById("hideUsersBtn");
             const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
             tabContainer.innerHTML = '';

             if (sortedUserNames.length === 0) {
                  tabContainer.style.display = 'none';
                  if(toggleArchivedBtn) toggleArchivedBtn.style.display = 'none';
                  if(hideUsersBtn) hideUsersBtn.style.display = 'none';
                   populateOtherUserDropdown(); document.getElementById('includeBalanceContainer').style.display = 'none';
                  return;
             } else {
                   if (tabContainer.style.display === 'none' || tabContainer.style.display === "") tabContainer.style.display = 'flex';
                  if(hideUsersBtn) hideUsersBtn.style.display = 'inline-block';
                  const hasArchived = Object.values(data).some(user => user.isActive === false);
                  if(toggleArchivedBtn) toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
                   if (currentUser) document.getElementById('includeBalanceContainer').style.display = 'flex'; else document.getElementById('includeBalanceContainer').style.display = 'none';
             }
             sortedUserNames.forEach(name => {
                  const user = data[name];
                   if (user && (user.isActive !== false || showArchivedUsers)) {
                       const btn = document.createElement("button"); btn.textContent = name;
                       btn.onclick = () => selectUser(name); btn.classList.add('user-tab-button');
                       if (user.isActive === false) btn.classList.add('archived');
                       if(name === currentUser) btn.classList.add('active-user-tab');
                       tabContainer.appendChild(btn);
                   }
             });
             applyTranslationsToUI(); populateOtherUserDropdown();
        }

        function toggleUsers() {
            const tabContainer = document.getElementById("userTabs");
             if (Object.keys(data).length === 0) { tabContainer.style.display = 'none'; return; }
             tabContainer.style.display = (tabContainer.style.display === "none" || tabContainer.style.display === "") ? "flex" : "none";
        }

        function selectUser(name) {
             if (!data[name]) {
                 currentUser = null; currentlyViewedMonth = null; localStorage.removeItem('lastSelectedUser');
                 fullRender(); renderUserTabs(); populateOtherUserDropdown(); return;
             }
             currentUser = name; localStorage.setItem('lastSelectedUser', name);
             document.getElementById("selectedUserName").textContent = name;
             document.getElementById("userControl").style.display = "block";
             document.getElementById('previousBalancePaymentsSection').style.display = 'block';
             document.getElementById('includeBalanceContainer').style.display = 'flex';
             renderUserTabs();
             populateOtherUserDropdown();
             let monthToView = currentlyViewedMonth;
             if (!monthToView || !data[name]?.months?.[monthToView]) {
                 monthToView = getCurrentMonth();
             }
             currentlyViewedMonth = monthToView;
             if (!data[name].months) data[name].months = {};
             if (!data[name].months[currentlyViewedMonth]) {
                 data[name].months[currentlyViewedMonth] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
             }
             const rate = Number(data[name]?.rate) || 0;
             document.getElementById("userRate").value = rate === 0 ? '' : rate;
             const overtimeRate = Number(data[name]?.overtimeRate) || 8;
             document.getElementById("userOvertimeRate").value = overtimeRate === 8 ? '' : overtimeRate;
             const monthDataForInput = data[name]?.months?.[currentlyViewedMonth];
             if (monthDataForInput) {
                 const carriedOver = monthDataForInput.carriedOverBalance || 0;
                 document.getElementById("manualCarriedOverBalance").value = Number(carriedOver) === 0 ? '' : Number(carriedOver);
             } else {
                 document.getElementById("manualCarriedOverBalance").value = '';
             }
             updateMonthDisplay(); scheduleFullRender(150);
            const dataManagementButtons = document.getElementById('dataManagementButtons');
            if (dataManagementButtons.style.display === 'flex' || dataManagementButtons.style.display === 'block') {
                const archiveBtn = document.getElementById('archiveUserBtn');
                if (archiveBtn) {
                    if (currentUser && data[currentUser]) { archiveBtn.style.display = 'inline-block'; applyTranslationsToUI(); }
                    else { archiveBtn.style.display = 'none'; }
                }
                 const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
                  if (toggleArchivedBtn) {
                    const hasArchived = Object.values(data).some(u => u.isActive === false);
                    toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
                 }
            }
        }

        document.getElementById("userRate").addEventListener("input", (event) => {
            if (currentUser && data[currentUser]) {
                 const rateVal = parseFloat(event.target.value);
                 data[currentUser].rate = !isNaN(rateVal) && rateVal >= 0 ? rateVal : 0;
                 saveData();
                 if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                 if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                 event.target.value = data[currentUser].rate === 0 ? '' : data[currentUser].rate;
             }
        });

        document.getElementById("userOvertimeRate").addEventListener("input", (event) => {
            if (currentUser && data[currentUser]) {
                const inputElement = event.target; let otRateVal = parseFloat(inputElement.value);
                let valueToSave = (inputElement.value.trim() === '' || isNaN(otRateVal) || otRateVal <= 0) ? 8 : otRateVal;
                update(null, -1, 'overtimeRate', valueToSave, inputElement);
                 setTimeout(() => {
                     const savedOtRate = Number(data[currentUser].overtimeRate) || 8;
                     if (savedOtRate === 8 && inputElement.value.trim() !== '') inputElement.value = '';
                     else if (savedOtRate !== 8 && parseFloat(inputElement.value) !== savedOtRate) inputElement.value = savedOtRate;
                 }, 50);
                 setTimeout(() => {
                     if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                     if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                 }, 100);
            }
        });

        document.getElementById("manualCarriedOverBalance").addEventListener("change", (event) => {
            if (!currentUser || !currentlyViewedMonth || !data[currentUser]?.months?.[currentlyViewedMonth]) {
                 event.target.value = ''; return;
             }
              const balanceVal = parseFloat(event.target.value) || 0;
              const monthData = data[currentUser].months[currentlyViewedMonth];
              if (Math.abs(Number(balanceVal.toFixed(2)) - Number((monthData.carriedOverBalance || 0).toFixed(2))) > 0.001) {
                   monthData.carriedOverBalance = balanceVal; saveData();
                   if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                   if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
              }
              event.target.value = Number(monthData.carriedOverBalance) === 0 ? '' : Number(monthData.carriedOverBalance);
        });

        function renderPreviousBalancePayments(monthKey) {
            const paymentListDiv = document.getElementById('paymentList'); paymentListDiv.innerHTML = '';
            const payments = data[currentUser]?.months?.[monthKey]?.previousBalancePayments;
            if (!currentUser || !monthKey || !Array.isArray(payments) || payments.length === 0) {
                paymentListDiv.innerHTML = `<p>${translate('noPaymentsRecorded')}</p>`; return;
            }
            const sortedPayments = [...payments].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedPayments.forEach((p) => {
                const actualIndex = payments.findIndex(origP => origP === p);
                 if (!p || typeof p !== 'object' || p.amount === undefined) { return; }
                const entry = document.createElement('div'); entry.className = 'payment-entry';
                const details = document.createElement('span'); details.className = 'payment-details';
                let paymentDateStr = translate('noDate');
                if (p.date) {
                    try {
                        const dateObj = new Date(p.date);
                        if (!isNaN(dateObj.getTime())) {
                             paymentDateStr = dateObj.toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN' : 'en-GB', {year:'numeric',month:'numeric',day:'numeric'});
                        }
                    } catch (e) { console.warn("Invalid payment date stored:", p.date); }
                }
                details.textContent = `${translate('amountLabel')} ${(Number(p.amount)||0).toFixed(2)}, ${translate('dateLabel')} ${paymentDateStr}${p.notes ? ` (${p.notes})` : ''}`;
                const btn = document.createElement('button'); btn.className = 'delete-payment-btn'; btn.textContent = '✕';
                btn.onclick = () => deletePreviousBalancePayment(monthKey, actualIndex);
                entry.append(details, btn); paymentListDiv.appendChild(entry);
            });
        }
        function addPreviousBalancePayment() {
             if (!currentUser || !currentlyViewedMonth || !data[currentUser]?.months?.[currentlyViewedMonth]) {
                 alert(translate('alertSelectUserMonth')); return;
             }
            const amountInput = document.getElementById('paymentAmount');
            const dateInput = document.getElementById('paymentDate');
            const notesInput = document.getElementById('paymentNotes');
            const amount = parseFloat(amountInput.value);
            const paymentDateValue = dateInput.value;
            if (isNaN(amount) || amount <= 0) { alert(translate('alertEnterValidAmount')); return; }
            if (!paymentDateValue) { alert(translate('alertPaymentDateRequired')); return; }
            const notes = notesInput.value.trim();
            const monthData = data[currentUser].months[currentlyViewedMonth];
            if(!Array.isArray(monthData.previousBalancePayments)) monthData.previousBalancePayments = [];
            const [year, month, day] = paymentDateValue.split('-').map(Number);
            const paymentDateObj = new Date(year, month - 1, day);
            monthData.previousBalancePayments.push({ amount, date: paymentDateObj.toISOString(), notes });
            saveData(); renderPreviousBalancePayments(currentlyViewedMonth);
            amountInput.value = ''; dateInput.value = ''; notesInput.value = '';
            alert(translate('alertPaymentAdded'));
            if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
            if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
        }
        function deletePreviousBalancePayment(monthKey, index) {
            const payments = data[currentUser]?.months?.[monthKey]?.previousBalancePayments;
            if (!payments || index < 0 || index >= payments.length || !payments[index]) { return; }
            const payment = payments[index];
            if (confirm(translate('confirmDeletePayment', {amount: (Number(payment.amount)||0).toFixed(2)}))) {
                payments.splice(index, 1); saveData(); renderPreviousBalancePayments(monthKey);
                alert(translate('alertPaymentDeleted'));
                if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
            }
        }

        function updateMonthDisplay() {
            const monthDisplay = document.getElementById('currentMonthDisplay');
            const prevBtn = document.querySelector('#monthNav button:first-child');
            const nextBtn = document.querySelector('#monthNav button:last-child');
            const quickChangeBtn = document.getElementById('quickMonthChangeBtn');
            const manualBalanceInput = document.getElementById("manualCarriedOverBalance");
            const overtimeRateInput = document.getElementById("userOvertimeRate");

            if (monthDisplay && currentlyViewedMonth) {
                const [year, monthNum] = currentlyViewedMonth.split('-').map(Number);
                monthDisplay.textContent = `${new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long' }).format(new Date(year, monthNum - 1, 1))} ${year}`;
                if (currentUser && data[currentUser]?.months) {
                    prevBtn.disabled = false;
                    nextBtn.disabled = currentlyViewedMonth >= getCurrentMonth();
                    if(quickChangeBtn) quickChangeBtn.style.display = 'inline-block';
                    const monthData = data[currentUser].months[currentlyViewedMonth];
                     if (manualBalanceInput) {
                         manualBalanceInput.value = monthData && Number(monthData.carriedOverBalance) !== 0 ? Number(monthData.carriedOverBalance) : '';
                     }
                     if (overtimeRateInput && currentUser && data[currentUser]) {
                         const overtimeRate = Number(data[currentUser].overtimeRate) || 8;
                         overtimeRateInput.value = overtimeRate === 8 ? '' : overtimeRate;
                     }
                } else {
                    [prevBtn, nextBtn].forEach(b=>b.disabled=true);
                    if(quickChangeBtn) quickChangeBtn.style.display='none';
                    if(manualBalanceInput) manualBalanceInput.value='';
                    if(overtimeRateInput) overtimeRateInput.value = '';
                }
            } else if (monthDisplay) {
                monthDisplay.textContent = ''; [prevBtn, nextBtn].forEach(b=>b.disabled=true);
                if(quickChangeBtn) quickChangeBtn.style.display='none';
                if(manualBalanceInput) manualBalanceInput.value='';
                if(overtimeRateInput) overtimeRateInput.value = '';
            }
             checkReminders();
        }

        function getRelativeMonthKey(monthKey, offset) {
            if(!monthKey) return null;
            const [y, m] = monthKey.split('-').map(Number); const date = new Date(y, m - 1, 1);
            date.setMonth(date.getMonth() + offset);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}`;
        }

        function goToPreviousMonth() {
             if(currentUser && currentlyViewedMonth){
                 const prevKey = getRelativeMonthKey(currentlyViewedMonth, -1);
                 currentlyViewedMonth = prevKey;
                 if (!data[currentUser].months[currentlyViewedMonth]) {
                    data[currentUser].months[currentlyViewedMonth] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
                 }
                 updateMonthDisplay(); scheduleFullRender(50);
             }
        }

        function goToNextMonth() {
            if (currentUser && currentlyViewedMonth && data[currentUser]) {
                const currentMonthKey = currentlyViewedMonth; const nextMonthKey = getRelativeMonthKey(currentMonthKey, 1);
                if (nextMonthKey > getCurrentMonth()) { alert(translate('cannotGoToFutureMonth')); return; }
                const currentMonthFullTotals = calculateFullMonthTotals(currentUser, currentMonthKey);
                const currentMonthData = data[currentUser].months[currentMonthKey];
                const currentMonthCarried = Number(currentMonthData?.carriedOverBalance) || 0;
                const currentMonthPrevBalPayments = (Array.isArray(currentMonthData?.previousBalancePayments))
                    ? currentMonthData.previousBalancePayments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0) : 0;
                const previousMonthFinalBalance = (currentMonthFullTotals.grossTotal + currentMonthCarried) - currentMonthFullTotals.totalDailyReceived - currentMonthPrevBalPayments;
                const monthNameForConfirm = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long', year: 'numeric' })
                                                .format(new Date(nextMonthKey.split('-')[0], nextMonthKey.split('-')[1] - 1, 1));
                const confirmMessageKey = 'confirmCarryOverBalance';
                const confirmMessageParams = { amount: previousMonthFinalBalance.toFixed(2), month: monthNameForConfirm };
                let message = translate(confirmMessageKey, confirmMessageParams);
                if (previousMonthFinalBalance !== 0 && confirm(message)) {
                    if (!data[currentUser].months) data[currentUser].months = {};
                    if (!data[currentUser].months[nextMonthKey]) {
                        data[currentUser].months[nextMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
                    }
                    data[currentUser].months[nextMonthKey].carriedOverBalance = parseFloat(previousMonthFinalBalance.toFixed(2));
                    saveData();
                } else if (previousMonthFinalBalance === 0) {
                     if (!data[currentUser].months) data[currentUser].months = {};
                     if (!data[currentUser].months[nextMonthKey]) {
                        data[currentUser].months[nextMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
                     }
                }
                currentlyViewedMonth = nextMonthKey; updateMonthDisplay(); scheduleFullRender(50);
            }
        }

        function promptQuickMonthChange() {
             if(!currentUser){alert(translate('pleaseSelectUser')); return;}
             const monthInput = prompt(translate('promptMonthInput'),currentlyViewedMonth||getCurrentMonth());
             if(!monthInput) return; const trimmedInput = monthInput.trim();
             if (!/^\d{4}-\d{2}$/.test(trimmedInput)){ alert(translate('alertInvalidMonthFormat')); return; }
             const [year, monthNum] = trimmedInput.split('-').map(Number);
             if(year < 1900 || year > 2100 || monthNum < 1 || monthNum > 12){ alert(translate('alertInvalidMonthFormat')); return; }
             const newMonthKey = `${year}-${monthNum.toString().padStart(2, '0')}`;
             if(newMonthKey > getCurrentMonth()){ alert(translate('cannotGoToFutureMonth')); return; }
             if (!data[currentUser].months[newMonthKey]) {
                data[currentUser].months[newMonthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
             }
             currentlyViewedMonth = newMonthKey; updateMonthDisplay(); scheduleFullRender(50);
        }

        function calculateFullMonthTotals(userName, monthKey) {
            const userData = data[userName];
            if (!userData?.months?.[monthKey] || !Array.isArray(userData.months[monthKey].days)) {
                 return { totalPresent:0, totalOvertimeHours:0, totalRent:0, totalFood:0, totalDailyReceived:0, grossTotal:0 };
            }
            const daysData = userData.months[monthKey].days; let p=0, ot=0, r=0, f=0, rec=0;
            daysData.forEach(d => {
                if(d && typeof d === 'object'){
                    const statusText = (d.status||'').toUpperCase(); let dayAttendanceValue = 0;
                    const multiplierMatch = statusText.match(/^(\d+)P$/);
                    if (multiplierMatch) {
                         const multiplier = parseInt(multiplierMatch[1]);
                         if (!isNaN(multiplier) && multiplier > 0) dayAttendanceValue = multiplier;
                    } else if (statusText === 'P') dayAttendanceValue = 1;
                    else if (statusText === 'H') dayAttendanceValue = 0.5;
                    p += dayAttendanceValue; ot+=Number(d.overtime)||0; r+=Number(d.rent)||0; f+=Number(d.food)||0; rec+=Number(d.received)||0;
                }
            });
            const rate = Number(userData.rate)||0; const otRate = Number(userData.overtimeRate) || 8;
            const hazri = p * rate; const otAmount = (rate > 0 && otRate > 0) ? (ot * rate) / otRate : 0;
            const gross = hazri + otAmount + r + f;
            return {
                totalPresent: parseFloat(p.toFixed(2)), totalOvertimeHours: parseFloat(ot.toFixed(1)),
                totalRent: parseFloat(r.toFixed(2)), totalFood: parseFloat(f.toFixed(2)),
                totalDailyReceived: parseFloat(rec.toFixed(2)), grossTotal: parseFloat(gross.toFixed(2)),
            };
        }

        function calculatePeriodTotals(userName, monthKey, startDayIndex, endDayIndexExclusive) { // endDayIndex is exclusive for slice
            const userData = data[userName];
             if (!userData?.months?.[monthKey] || !Array.isArray(userData.months[monthKey].days)) {
                 return { totalPresent:0, totalOvertimeHours:0, totalRent:0, totalFood:0, totalDailyReceived:0, periodGross:0, periodNet:0 };
            }
             const actualDaysInMonthArray = userData.months[monthKey].days;
             const safeStart = Math.max(0, startDayIndex);
             // Ensure endDayIndexExclusive does not exceed array length for slice
             const safeEndExclusive = Math.min(actualDaysInMonthArray.length, endDayIndexExclusive);

            const daysDataForPeriod = actualDaysInMonthArray.slice(safeStart, safeEndExclusive);
            let p=0, ot=0, r=0, f=0, rec=0;
            daysDataForPeriod.forEach(d => {
                 if(d && typeof d === 'object'){
                    const statusText = (d.status||'').toUpperCase(); let dayAttendanceValue = 0;
                    const multiplierMatch = statusText.match(/^(\d+)P$/);
                    if (multiplierMatch) {
                         const multiplier = parseInt(multiplierMatch[1]);
                         if (!isNaN(multiplier) && multiplier > 0) dayAttendanceValue = multiplier;
                    } else if (statusText === 'P') dayAttendanceValue = 1;
                    else if (statusText === 'H') dayAttendanceValue = 0.5;
                    p += dayAttendanceValue; ot+=Number(d.overtime)||0; r+=Number(d.rent)||0; f+=Number(d.food)||0; rec+=Number(d.received)||0;
                }
            });
            const rate = Number(userData.rate)||0; const otRate = Number(userData.overtimeRate) || 8;
            const hazri = p * rate; const otAmount = (rate > 0 && otRate > 0) ? (ot * rate) / otRate : 0;
            const periodGross = hazri + otAmount + r + f; const periodNet = periodGross - rec;
            return {
                 totalPresent: parseFloat(p.toFixed(2)), totalOvertimeHours: parseFloat(ot.toFixed(1)),
                totalRent: parseFloat(r.toFixed(2)), totalFood: parseFloat(f.toFixed(2)),
                totalDailyReceived: parseFloat(rec.toFixed(2)),
                periodGross: parseFloat(periodGross.toFixed(2)), periodNet: parseFloat(periodNet.toFixed(2))
            };
        }

        function getCurrentDateString() {
            const n = new Date(); return `${n.getDate()}/${n.getMonth() + 1}/${n.getFullYear()}`;
        }

        function getDaysInMonth(year, monthIndex) {
            return new Date(year, monthIndex + 1, 0).getDate();
        }

        function calculateOverallReport(userName) {
             const userData = data[userName]; if (!userData?.months || Object.keys(userData.months).length === 0) { return null; }
            const sortedMonthKeys = Object.keys(userData.months).sort();
            let totP=0, totOT=0, totR=0, totF=0, totDR=0, totG=0, totPBP=0;
            const initBal = Number(userData.months[sortedMonthKeys[0]]?.carriedOverBalance) || 0;
            const initBalMKey = sortedMonthKeys[0];
            sortedMonthKeys.forEach(mKey => {
                 const mData = userData.months[mKey];
                 if (mData && typeof mData === 'object') {
                      const mTots = calculateFullMonthTotals(userName, mKey);
                      totP+=mTots.totalPresent; totOT+=mTots.totalOvertimeHours; totR+=mTots.totalRent;
                      totF+=mTots.totalFood; totDR+=mTots.totalDailyReceived; totG+=mTots.grossTotal;
                      if (Array.isArray(mData.previousBalancePayments)) {
                           mData.previousBalancePayments.forEach(p => { if (p&&typeof p==='object'&&p.amount!==undefined) totPBP+=(Number(p.amount)||0); });
                      }
                 }
            });
            const overallFinBal = parseFloat((totG + initBal - totDR - totPBP).toFixed(2));
            return {
                 totalOverallPresent:parseFloat(totP.toFixed(2)), totalOverallOvertimeHours:parseFloat(totOT.toFixed(1)),
                 totalOverallRent:parseFloat(totR.toFixed(2)), totalOverallFood:parseFloat(totF.toFixed(2)),
                 totalOverallDailyReceived:parseFloat(totDR.toFixed(2)), totalOverallPrevBalPayments:parseFloat(totPBP.toFixed(2)),
                 totalOverallGross:parseFloat(totG.toFixed(2)), initialCarriedOverBalance:parseFloat(initBal.toFixed(2)),
                 initialCarriedOverMonthKey:initBalMKey, overallFinalBalance:overallFinBal
            };
        }

        function displayOverallReport() {
            const monthlySummarySection = document.getElementById('summarySection');
            const overallSummarySection = document.getElementById('overallSummarySection');
            const tableContainer = document.getElementById('tableContainer');
            const paymentsSection = document.getElementById('previousBalancePaymentsSection');
            if (!currentUser) {
                monthlySummarySection.style.display = 'none';
                overallSummarySection.innerHTML = `<p>${translate('pleaseSelectUser')}</p>`;
                overallSummarySection.style.display = 'block';
                if(tableContainer) tableContainer.style.display = 'none';
                if(paymentsSection) paymentsSection.style.display = 'none';
                return;
            }
            const overallTotals = calculateOverallReport(currentUser);
            monthlySummarySection.style.display = 'none';
            if(tableContainer) tableContainer.style.display = 'none';
            if(paymentsSection) paymentsSection.style.display = 'none';
            overallSummarySection.innerHTML = '';
            if (!overallTotals) {
                 overallSummarySection.innerHTML = `<p>${translate('noDataForOverallReport', { user: currentUser })}</p>`;
                 overallSummarySection.style.display = 'block'; return;
            }
            let html = `<h3>${translate('overallReportTitle', { user: currentUser })}</h3>
                <p>${translate('overallAttendanceSummary', { days: overallTotals.totalOverallPresent.toFixed(2) })}</p>
                <p>${translate('overallOvertimeSummary', { hours: overallTotals.totalOverallOvertimeHours.toFixed(1) })}</p>
                <p>${translate('overallRentSummary', { amount: overallTotals.totalOverallRent.toFixed(2) })}</p>
                <p>${translate('overallFoodSummary', { amount: overallTotals.totalOverallFood.toFixed(2) })}</p>
                <hr><p><strong>${translate('overallGrossSummary', { amount: overallTotals.totalOverallGross.toFixed(2) })}</strong></p>
                 <p><strong>${translate('initialCarriedOverBalanceSummary', { amount: overallTotals.initialCarriedOverBalance.toFixed(2), month: overallTotals.initialCarriedOverMonthKey })}</strong></p>
                 <hr><p>${translate('overallDailyReceivedSummary', { amount: overallTotals.totalOverallDailyReceived.toFixed(2) })}</p>
                 <p>${translate('overallPrevBalPaymentsSummary', { amount: overallTotals.totalOverallPrevBalPayments.toFixed(2) })}</p>
                 <hr><p><strong>${translate('overallFinalBalanceDue', { amount: overallTotals.overallFinalBalance.toFixed(2) })}</strong></p>`;
            overallSummarySection.innerHTML = html;
            overallSummarySection.style.display = 'block';
            applyTranslationsToUI();
            const shareButtonWrapper = document.getElementById('shareReportButtonWrapper');
             if(shareButtonWrapper) shareButtonWrapper.style.display = 'none';
             const footerDiv = document.getElementById('reportFooter');
             if(footerDiv) footerDiv.textContent = '';
        }

        function updateTableFooter(monthKey) {
            const tableFooter = document.getElementById('attendanceTableFooter');
            if (!tableFooter) return;
            if (activeReportType === 'fullMonth' && currentUser && monthKey && data[currentUser]?.months?.[monthKey]?.days) {
                tableFooter.style.display = 'table-footer-group';
                const totals = calculateFullMonthTotals(currentUser, monthKey);
                document.getElementById('totalOvertime').textContent = totals.totalOvertimeHours.toFixed(1);
                document.getElementById('totalRent').textContent = totals.totalRent.toFixed(2);
                document.getElementById('totalFood').textContent = totals.totalFood.toFixed(2);
                document.getElementById('totalReceived').textContent = totals.totalDailyReceived.toFixed(2);
                document.getElementById('totalStatus').textContent = totals.totalPresent.toFixed(1) + ' P';
                const totalLabelCell = document.querySelector('#tableFooterRow td[data-translate-key="totalLabel"]');
                if(totalLabelCell) totalLabelCell.textContent = translate('totalLabel');
            } else {
                tableFooter.style.display = 'none';
            }
        }


        function renderTable(monthKey = currentlyViewedMonth) {
            const container = document.getElementById("tableContainer");
             if (!currentUser || !monthKey) { container.innerHTML = ""; return; }
             const userData = data[currentUser]; if (!userData) { container.innerHTML = ""; return; }

             const [year, monthIndexBase1] = monthKey.split('-').map(Number);
             if (isNaN(year) || year < 1900 || isNaN(monthIndexBase1) || monthIndexBase1 < 1 || monthIndexBase1 > 12) {
                 container.innerHTML = `<p>${translate('errorInvalidMonthKey', { monthKey: monthKey })}</p>`; return;
             }
             const daysInSelectedMonth = getDaysInMonth(year, monthIndexBase1 - 1);
              if (!userData.months[monthKey] || typeof userData.months[monthKey] !== 'object') {
                   userData.months[monthKey] = { carriedOverBalance: 0, previousBalancePayments: [], days: [] };
              }
              let fullMonthDaysData = userData.months[monthKey].days; let structureChanged = false;
                if (!Array.isArray(fullMonthDaysData) || fullMonthDaysData.length !== daysInSelectedMonth) {
                   const newDays = Array.from({ length: daysInSelectedMonth }, (_, i) => {
                        const existingDay = (Array.isArray(fullMonthDaysData) && i < fullMonthDaysData.length) ? fullMonthDaysData[i] : {};
                        return {
                            date: existingDay.date || `${i+1}/${monthIndexBase1}/${year}`,
                            status: existingDay.status || '', overtime: Number(existingDay.overtime) || 0,
                            rent: Number(existingDay.rent) || 0, food: Number(existingDay.food) || 0,
                            received: Number(existingDay.received) || 0, notes: existingDay.notes || '', updated: existingDay.updated || ''
                        };
                   });
                   userData.months[monthKey].days = newDays; fullMonthDaysData = newDays; structureChanged = true;
                } else {
                     let dayMigrationNeeded = false;
                     fullMonthDaysData = fullMonthDaysData.map((d, i) => {
                          if (!d || typeof d !== 'object') {
                              dayMigrationNeeded = true;
                              return { date: `${i+1}/${monthIndexBase1}/${year}`, status:'', overtime:0, rent:0, food:0, received:0, notes:'', updated:'' };
                          }
                           let updatedDay = {...d};
                           if (updatedDay.date === undefined) { updatedDay.date = `${i+1}/${monthIndexBase1}/${year}`; dayMigrationNeeded = true; }
                           if (updatedDay.status === undefined) { updatedDay.status = ''; dayMigrationNeeded = true; }
                           if (updatedDay.overtime === undefined || isNaN(Number(updatedDay.overtime))) { updatedDay.overtime = 0; dayMigrationNeeded = true; }
                           if (updatedDay.rent === undefined || isNaN(Number(updatedDay.rent))) { updatedDay.rent = 0; dayMigrationNeeded = true; }
                           if (updatedDay.food === undefined || isNaN(Number(updatedDay.food))) { updatedDay.food = 0; dayMigrationNeeded = true; }
                           if (updatedDay.received === undefined || isNaN(Number(updatedDay.received))) { updatedDay.received = 0; dayMigrationNeeded = true; }
                           if (updatedDay.notes === undefined) { updatedDay.notes = ''; dayMigrationNeeded = true; }
                           if (updatedDay.updated === undefined) { updatedDay.updated = ''; dayMigrationNeeded = true; }
                            if (updatedDay.location !== undefined) { delete updatedDay.location; dayMigrationNeeded = true; }
                           return updatedDay;
                     });
                      if (dayMigrationNeeded) { userData.months[monthKey].days = fullMonthDaysData; structureChanged = true; }
                }
                if (typeof userData.months[monthKey].carriedOverBalance !== 'number') { userData.months[monthKey].carriedOverBalance = 0; structureChanged = true; }
                 if (!Array.isArray(userData.months[monthKey].previousBalancePayments)) { userData.months[monthKey].previousBalancePayments = []; structureChanged = true; }
                if (structureChanged) { saveData(); }

            let displayStartIndex = 0;
            let displayEndIndex = daysInSelectedMonth - 1;
            if (activeReportType === 'firstHalfIndependent' || activeReportType === 'firstHalfCurrent') {
                displayEndIndex = Math.min(14, daysInSelectedMonth - 1);
            } else if (activeReportType === 'afterFifteenthIndependent' || activeReportType === 'afterFifteenthCurrent') {
                displayStartIndex = Math.min(15, daysInSelectedMonth -1);
                if (displayStartIndex > displayEndIndex && daysInSelectedMonth > 0) { // Check daysInSelectedMonth > 0
                    container.innerHTML = `<p>${translate('noDataForMonth', { monthKey: monthKey + " (" + activeReportType.substring(activeReportType.lastIndexOf("f")) + ")"})}</p>`; return;
                }
            }
             if (daysInSelectedMonth === 0 && activeReportType !== 'fullMonth') { // Handle empty month for period views
                container.innerHTML = `<p>${translate('noDataForMonth', { monthKey: monthKey + " (" + activeReportType.substring(activeReportType.lastIndexOf("f")) + ")"})}</p>`; return;
            }

            const daysToDisplayInTable = (daysInSelectedMonth > 0) ? fullMonthDaysData.slice(displayStartIndex, displayEndIndex + 1) : [];
            if (daysToDisplayInTable.length === 0 && activeReportType !== 'fullMonth' && daysInSelectedMonth > 0) {
                 container.innerHTML = `<p>${translate('noDataForMonth', { monthKey: monthKey + " (" + activeReportType.substring(activeReportType.lastIndexOf("f")) + ")"})}</p>`; return;
            } else if (daysToDisplayInTable.length === 0 && daysInSelectedMonth === 0) { // Handles completely empty/new month
                 container.innerHTML = `<p>${translate('noDataForMonth', { monthKey: monthKey})}</p>`; return;
            }


              const todayDateString = getCurrentDateString();
              let html = `<div class="table-responsive"><table><thead><tr>
                          <th>${translate('dateHeaderTbl')}</th><th>${translate('statusHeaderTbl')}</th>
                          <th>${translate('otHeaderTbl')}</th><th>${translate('rentHeaderTbl')}</th>
                          <th>${translate('foodHeaderTbl')}</th><th>${translate('receivedHeaderTbl')}</th>
                          <th>${translate('notesHeaderTbl')}</th><th>${translate('editedHeaderTbl')}</th>
                          </tr></thead><tbody>`;

             daysToDisplayInTable.forEach((dayDataFromSlice, relativeIndex) => {
                  const originalDayIndex = displayStartIndex + relativeIndex;
                  const currentDay = dayDataFromSlice;
                  const dayDateParts = (currentDay.date || '').split('/').map(Number);
                   const dayDateObj = (dayDateParts.length === 3 && !isNaN(dayDateParts[0]) && !isNaN(dayDateParts[1]) && !isNaN(dayDateParts[2]))
                                       ? new Date(dayDateParts[2], dayDateParts[1] - 1, dayDateParts[0]) : null;
                  const formattedDayDateString = dayDateObj ? `${dayDateObj.getDate()}/${dayDateObj.getMonth()+1}/${dayDateObj.getFullYear()}` : '';
                  const isCurrentDayRow = formattedDayDateString === todayDateString;
                  let dayName = ''; let dateDisplay = currentDay.date || '-'; let dayOfWeekClass = '';
                  if (dayDateObj && !isNaN(dayDateObj.getTime())) {
                      dayName = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'long' }).format(dayDateObj);
                      const dayIndexInWeek = dayDateObj.getDay();
                      if (dayIndexInWeek === 0) dayOfWeekClass = 'sunday-row'; else if (dayIndexInWeek === 5) dayOfWeekClass = 'friday-row';
                  }
                  let finalRowClass = isCurrentDayRow ? 'current-day-row' : '';
                  if (dayOfWeekClass) finalRowClass += (finalRowClass ? ' ' : '') + dayOfWeekClass;
                  const overtimeValue = Number(currentDay.overtime) === 0 ? '' : String(currentDay.overtime);
                  const rentValue = Number(currentDay.rent) === 0 ? '' : String(currentDay.rent);
                  const foodValue = Number(currentDay.food) === 0 ? '' : String(currentDay.food);
                  const receivedValue = Number(currentDay.received) === 0 ? '' : String(currentDay.received);
                  const rentTdClass = `rent-cell ${rentValue !== '' ? 'input-has-value' : ''}`;
                  const foodTdClass = `food-cell ${foodValue !== '' ? 'input-has-value' : ''}`;
                  const receivedTdClass = `received-cell ${receivedValue !== '' ? 'input-has-value' : ''}`;
                  html += `<tr class="${finalRowClass}">
                       <td>
                           ${dayName ? `<span class="day-name-in-date-cell">${dayName}</span>` : ''}
                           ${dateDisplay}
                       </td>
                       <td><input type="text" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="status" value="${currentDay.status || ''}" maxlength="3" autocomplete="off"></td>
                       <td><input type="number" step="0.1" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="overtime" value="${overtimeValue}" min="0" autocomplete="off"></td>
                       <td class="${rentTdClass}"><input type="number" step="any" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="rent" value="${rentValue}" min="0" autocomplete="off"></td>
                       <td class="${foodTdClass}"><input type="number" step="any" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="food" value="${foodValue}" min="0" autocomplete="off"></td>
                       <td class="${receivedTdClass}"><input type="number" step="any" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="received" value="${receivedValue}" min="0" autocomplete="off"></td>
                       <td class="notes-cell" onclick="openNotesModal('${monthKey}', ${originalDayIndex})" title="${translate('notesPlaceholder')}">
                           <span class="note-preview">${(currentDay.notes || '').substring(0, 20)}${(currentDay.notes || '').length > 20 ? '...' : ''}</span>
                       </td>
                       <td class="edited-datetime-cell">
                           <input type="text" class="edited-date-input" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="updated_date"
                                  placeholder="${translate('editedDatePlaceholder')}"
                                  value="${currentDay.updated ? new Date(currentDay.updated).toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-') : ''}"
                                  maxlength="10" autocomplete="off">
                           <input type="text" class="edited-time-input" data-month="${monthKey}" data-index="${originalDayIndex}" data-field="updated_time"
                                  placeholder="${translate('editedTimePlaceholder')}"
                                  value="${currentDay.updated ? new Date(currentDay.updated).toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'}) : ''}"
                                  maxlength="5" autocomplete="off">
                       </td></tr>`;
             });
             html += `</tbody>
                      <tfoot id="attendanceTableFooter" style="display: none;">
                          <tr id="tableFooterRow">
                              <td data-translate-key="totalLabel">Total</td>
                              <td id="totalStatus"></td>
                              <td id="totalOvertime">0</td>
                              <td id="totalRent">0</td>
                              <td id="totalFood">0</td>
                              <td id="totalReceived">0</td>
                              <td></td>
                              <td></td>
                          </tr>
                      </tfoot>`;
             html += `</table></div>`; container.innerHTML = html;
             addTableEventListeners();
             renderPreviousBalancePayments(monthKey);
             updateTableFooter(monthKey);
             const manualBalanceInput = document.getElementById("manualCarriedOverBalance");
             if (manualBalanceInput && currentUser && monthKey && data[currentUser]?.months?.[monthKey]) {
                 const monthData = data[currentUser].months[monthKey];
                 manualBalanceInput.value = Number(monthData.carriedOverBalance) === 0 ? '' : Number(monthData.carriedOverBalance);
             } else if (manualBalanceInput) { manualBalanceInput.value = ''; }
             const overtimeRateInput = document.getElementById("userOvertimeRate");
             if (overtimeRateInput && currentUser && data[currentUser]) {
                 const overtimeRate = Number(data[currentUser].overtimeRate) || 8;
                 overtimeRateInput.value = overtimeRate === 8 ? '' : overtimeRate;
             } else if (overtimeRateInput) { overtimeRateInput.value = ''; }
             container.querySelectorAll('td.rent-cell input, td.food-cell input, td.received-cell input').forEach(input => {
                const td = input.parentElement;
                if (input.value.trim() !== '') td.classList.add('input-has-value'); else td.classList.remove('input-has-value');
             });
             applyTranslationsToUI();
        }

        function addTableEventListeners() {
            const table = document.querySelector('#tableContainer table');
              if (!table) { return; }
              table.removeEventListener('input', handleTableInput);
              table.addEventListener('input', handleTableInput);
        }

        function handleTableInput(event) {
             const target = event.target;
             if (target.tagName === 'INPUT' && target.dataset.field && target.parentElement.tagName === 'TD') {
                 const { month, index, field } = target.dataset; let valueToStore; let rawValue = target.value;
                 const dayIndex = parseInt(index);
                 if (['rent', 'food', 'received', 'overtime'].includes(field)) {
                     const td = target.parentElement;
                     if (rawValue.trim() !== '') td.classList.add('input-has-value'); else td.classList.remove('input-has-value');
                     if (rawValue.trim() === '' || rawValue.trim() === '-') valueToStore = 0;
                     else {
                         valueToStore = parseFloat(rawValue);
                         if (isNaN(valueToStore)) valueToStore = 0;
                         else if (valueToStore < 0 && field !== 'manualCarriedOverBalance') valueToStore = 0;
                     }
                     update(month, dayIndex, field, valueToStore, target);
                 } else if (field === 'status') {
                      valueToStore = rawValue.trim().toUpperCase();
                       const isValidStatus = valueToStore === '' || /^[PHAL]$/.test(valueToStore) || /^\d+P$/.test(valueToStore);
                       if (!isValidStatus && valueToStore !== '') {
                            target.value = data[currentUser]?.months?.[month]?.days?.[dayIndex]?.[field] || ''; return;
                       }
                       update(month, dayIndex, field, valueToStore, target);
                 } else if (field === 'updated_date' || field === 'updated_time') {
                     valueToStore = rawValue.trim(); update(month, dayIndex, field, valueToStore, target);
                 }
             }
        }

        function update(month, i, field, value, inputElement) {
            if (i === -1 && currentUser && data[currentUser]) {
                 const user = data[currentUser]; let valueChanged = false;
                 if (field === 'overtimeRate') {
                      const oldVal = user.overtimeRate || 8;
                      user.overtimeRate = (value === '' || isNaN(parseFloat(value)) || parseFloat(value) <=0 ) ? 8 : parseFloat(value);
                      valueChanged = user.overtimeRate !== oldVal;
                 } else if (field === 'rate') {
                      const oldVal = user.rate || 0;
                      user.rate = (value === '' || isNaN(parseFloat(value))) ? 0 : parseFloat(value);
                      valueChanged = user.rate !== oldVal;
                 }
                 if (valueChanged) saveData();
                 if (inputElement) {
                     if (field === 'overtimeRate') inputElement.value = (user.overtimeRate === 8) ? '' : user.overtimeRate;
                     else if (field === 'rate') inputElement.value = (user.rate === 0) ? '' : user.rate;
                 }
                if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                return;
            }

            if (!currentUser || !data[currentUser]?.months?.[month]?.days?.[i]) { return; }
            const day = data[currentUser].months[month].days[i];

            if (field === 'updated_date' || field === 'updated_time') {
                const dateInput = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_date"]`);
                const timeInput = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_time"]`);
                let dateStr = dateInput.value.trim(); let timeStr = timeInput.value.trim();
                if ((field === 'updated_date' && !dateStr && !timeStr) || (field === 'updated_time' && !timeStr && !dateStr)) {
                     if (day.updated) { day.updated = ''; saveData(); }
                    if (!dateStr) dateInput.value = ''; if (!timeStr) timeInput.value = '';
                    if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                    if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                    return;
                }
                const datePattern = /^\d{1,2}-\d{1,2}-\d{4}$/; const timePattern = /^\d{1,2}:\d{1,2}$/;
                if (dateStr && timeStr && datePattern.test(dateStr) && timePattern.test(timeStr)) {
                    const dateParts = dateStr.split('-'); const timeParts = timeStr.split(':');
                    if (dateParts.length === 3 && timeParts.length === 2) {
                        const dayParsed = parseInt(dateParts[0], 10); const monthParsed = parseInt(dateParts[1], 10);
                        const year = parseInt(dateParts[2], 10); const hours = parseInt(timeParts[0], 10);
                        const minutes = parseInt(timeParts[1], 10);
                        if (year >= 1900 && year <= 2100 && monthParsed >= 1 && monthParsed <= 12 &&
                            dayParsed >= 1 && dayParsed <= getDaysInMonth(year, monthParsed -1) &&
                            hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                            const parsedDate = new Date(year, monthParsed - 1, dayParsed, hours, minutes);
                            if (!isNaN(parsedDate.getTime())) {
                                const oldUpdatedValue = day.updated; day.updated = parsedDate.toISOString();
                                if (oldUpdatedValue !== day.updated) {
                                    saveData();
                                    if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                                    if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                                }
                                dateInput.value = parsedDate.toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                                timeInput.value = parsedDate.toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                            } else { if (inputElement !== document.activeElement) alert(translate('alertInvalidDateTimeFormat')); }
                        } else {
                            if (inputElement !== document.activeElement || (field==='updated_date' && value.length >= 10 || field==='updated_time' && value.length >= 5 )) {
                                alert(translate('alertInvalidDateTimeFormat'));
                            }
                        }
                    }
                } else if (inputElement === document.activeElement) { /* User is still typing */ }
                else if (!dateStr && !timeStr && day.updated) {
                     day.updated = ''; saveData();
                     if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                     if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                }
                return;
            }

            const currentValueInData = day[field]; let valueChanged = false;
            if (typeof value === 'number') {
                valueChanged = Math.abs(value - (Number(currentValueInData) || 0)) > 0.0001;
            } else {
                valueChanged = String(value) !== String(currentValueInData || '');
            }
            if (valueChanged) {
                day[field] = value;
                day.updated = new Date().toISOString();
                const dateInputElement = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_date"]`);
                const timeInputElement = document.querySelector(`input[data-month="${month}"][data-index="${i}"][data-field="updated_time"]`);
                if (dateInputElement && timeInputElement && day.updated) {
                    dateInputElement.value = new Date(day.updated).toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                    timeInputElement.value = new Date(day.updated).toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                }
                saveData();
            }
            if (inputElement && ['overtime', 'rent', 'food', 'received'].includes(field)) {
                const savedNumericValue = Number(day[field]) || 0;
                if (document.activeElement !== inputElement) {
                    inputElement.value = (savedNumericValue === 0) ? '' : String(savedNumericValue);
                }
            }
            if (valueChanged) {
                if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
                 updateTableFooter(month);
            }
        }

        function showSummary(calcType) {
            activeReportType = calcType;
            localStorage.setItem('activeReportType', activeReportType); // Save to localStorage

            const monthlySummary = document.getElementById("summarySection");
            const overallSummary = document.getElementById("overallSummarySection");
            const tableContainer = document.getElementById('tableContainer');
            const paymentsSection = document.getElementById('previousBalancePaymentsSection');
            const otherUserSelect = document.getElementById('otherUserForReport');
            const shareButtonWrapper = document.getElementById('shareReportButtonWrapper');
            const footerDiv = document.getElementById('reportFooter');

            overallSummary.style.display = 'none'; overallSummary.innerHTML = '';
            monthlySummary.style.display = 'block';
            if(tableContainer) tableContainer.style.display = 'block';
            if(paymentsSection) paymentsSection.style.display = 'block';
            if(shareButtonWrapper) shareButtonWrapper.style.display = 'flex';
            if(footerDiv) footerDiv.textContent = '';
            
            if(currentUser && currentlyViewedMonth) { // Render table based on new activeReportType
                renderTable(currentlyViewedMonth);
            }

            let selectedOtherUser = otherUserSelect ? otherUserSelect.value : '';
            if (selectedOtherUser === '') selectedOtherUser = null;

            if (!currentUser || !currentlyViewedMonth || !data[currentUser]?.months?.[currentlyViewedMonth]) {
                monthlySummary.innerHTML = `<p>${translate('alertSelectUserMonth')}</p>`;
                finalBalanceForReport = 0; combinedFinalBalanceForReport = 0; otherUserFinalBalanceForReport = 0;
                 if(shareButtonWrapper) shareButtonWrapper.style.display = 'none';
                 if(footerDiv) footerDiv.textContent = '';
                 updateTableFooter(currentlyViewedMonth);
                return;
            }

            const userData = data[currentUser]; const currentMonthKey = currentlyViewedMonth;
            const currentMonthData = userData.months[currentMonthKey];
            if (!currentMonthData || typeof currentMonthData !== 'object' || !Array.isArray(currentMonthData.days) || !Array.isArray(currentMonthData.previousBalancePayments)) {
                 monthlySummary.innerHTML = `<p>${translate('noDataForMonth', {monthKey: currentMonthKey})}</p>`;
                 finalBalanceForReport = 0; combinedFinalBalanceForReport = 0; otherUserFinalBalanceForReport = 0;
                 if(shareButtonWrapper) shareButtonWrapper.style.display = 'none'; if(footerDiv) footerDiv.textContent = '';
                 updateTableFooter(currentlyViewedMonth);
                 return;
            }

            let currentPeriodCarriedOverBalance = 0;
            let currentPeriodPrevBalPaymentsTotal = 0;
            let finalBalanceContextKey = 'finalBalanceDueForPeriod';
            let carriedOverBalanceContextKey = 'carriedOverBalanceFromPrevMonth';

            const [year, monthNum] = currentMonthKey.split('-').map(Number);
            const monthNameForTitle = new Intl.DateTimeFormat(currentLanguage === 'hi' ? 'hi-IN' : 'en-US', { month: 'long' }).format(new Date(year, monthNum - 1, 1));
            const actualDaysInMonth = currentMonthData.days.length;

            let periodStartDayIndex = 0;
            let periodEndDayIndex = actualDaysInMonth -1;

            let reportTitleKey = "";
            let reportTitleParams = {};
            let periodTypeForFooter = translate('reportPeriodFullMonth');

            switch (calcType) {
                case 'fullMonth':
                    currentPeriodCarriedOverBalance = Number(currentMonthData.carriedOverBalance) || 0;
                    currentPeriodPrevBalPaymentsTotal = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.reduce((sum, p) => {
                            if (!p.date) return sum + (Number(p.amount) || 0);
                            const d = new Date(p.date);
                            if (d.getFullYear() === year && d.getMonth() === (monthNum - 1)) {
                                return sum + (Number(p.amount) || 0);
                            }
                            return sum;
                          }, 0)
                        : 0;
                    reportTitleKey = 'reportTitleFull';
                    reportTitleParams = { days: actualDaysInMonth, month: monthNameForTitle, year };
                    periodTypeForFooter = translate('reportPeriodFullMonth');
                    break;
                case 'firstHalfCurrent':
                    periodEndDayIndex = Math.min(14, actualDaysInMonth - 1);
                    currentPeriodCarriedOverBalance = Number(currentMonthData.carriedOverBalance) || 0;
                    currentPeriodPrevBalPaymentsTotal = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.reduce((sum, p) => {
                            if (!p.date) return sum + (Number(p.amount) || 0);
                            const d = new Date(p.date);
                            if (d.getFullYear() === year && d.getMonth() === (monthNum - 1)) {
                                return sum + (Number(p.amount) || 0);
                            }
                            return sum;
                          }, 0)
                        : 0;
                    finalBalanceContextKey = 'finalBalanceDueFullMonthContext';
                    reportTitleKey = 'reportTitleFirstHalf';
                    reportTitleParams = { days: (periodEndDayIndex - periodStartDayIndex + 1 > 0 ? periodEndDayIndex - periodStartDayIndex + 1 : 0) , month: monthNameForTitle, year };
                    periodTypeForFooter = translate('reportPeriodFirstHalfInfo');
                    break;
                case 'afterFifteenthCurrent':
                    periodStartDayIndex = Math.min(15, actualDaysInMonth -1);
                     if (periodStartDayIndex > periodEndDayIndex && actualDaysInMonth > 0) {
                        monthlySummary.innerHTML = `<p>Invalid period for this month length.</p>`; return;
                    }
                    currentPeriodCarriedOverBalance = Number(currentMonthData.carriedOverBalance) || 0;
                    currentPeriodPrevBalPaymentsTotal = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.reduce((sum, p) => {
                            if (!p.date) return sum + (Number(p.amount) || 0);
                            const d = new Date(p.date);
                            if (d.getFullYear() === year && d.getMonth() === (monthNum - 1)) {
                                return sum + (Number(p.amount) || 0);
                            }
                            return sum;
                          }, 0)
                        : 0;
                    finalBalanceContextKey = 'finalBalanceDueFullMonthContext';
                    reportTitleKey = 'reportTitleAfterFifteenth';
                     reportTitleParams = { days: (periodEndDayIndex - periodStartDayIndex + 1 > 0 ? periodEndDayIndex - periodStartDayIndex + 1 : 0), month: monthNameForTitle, year };
                    periodTypeForFooter = translate('reportPeriodAfter15thInfo');
                    break;
                case 'firstHalfIndependent':
                    periodEndDayIndex = Math.min(14, actualDaysInMonth - 1);
                    currentPeriodCarriedOverBalance = Number(currentMonthData.carriedOverBalance) || 0;
                    currentPeriodPrevBalPaymentsTotal = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.filter(p => {
                            if (!p.date) return true;
                            const d = new Date(p.date);
                            return d.getFullYear() === year && d.getMonth() === (monthNum - 1) && d.getDate() >= 1 && d.getDate() <= 15;
                        }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0)
                        : 0;
                    reportTitleKey = 'reportTitleFirstHalf';
                     reportTitleParams = { days: (periodEndDayIndex - periodStartDayIndex + 1 > 0 ? periodEndDayIndex - periodStartDayIndex + 1 : 0), month: monthNameForTitle, year };
                    periodTypeForFooter = translate('reportPeriodFirstHalfIndie');
                    break;
                case 'afterFifteenthIndependent':
                    periodStartDayIndex = Math.min(15, actualDaysInMonth-1);
                     if (periodStartDayIndex > periodEndDayIndex && actualDaysInMonth > 0) {
                        monthlySummary.innerHTML = `<p>Invalid period for this month length.</p>`; return;
                    }
                    const firstHalfTotalsIndie = calculatePeriodTotals(currentUser, currentMonthKey, 0, Math.min(15, actualDaysInMonth)); // exclusive end
                    const prevMonthActualCarriedIndie = Number(currentMonthData.carriedOverBalance) || 0;
                    const firstHalfPrevBalPaymentsIndie = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.filter(p => {
                            if (!p.date) return true;
                            const d = new Date(p.date);
                            return d.getFullYear() === year && d.getMonth() === (monthNum - 1) && d.getDate() >= 1 && d.getDate() <= 15;
                        }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0)
                        : 0;
                    currentPeriodCarriedOverBalance = (firstHalfTotalsIndie.periodGross + prevMonthActualCarriedIndie) - firstHalfTotalsIndie.totalDailyReceived - firstHalfPrevBalPaymentsIndie;
                    carriedOverBalanceContextKey = 'carriedOverBalanceFromPrevPeriod';
                    currentPeriodPrevBalPaymentsTotal = (Array.isArray(currentMonthData.previousBalancePayments))
                        ? currentMonthData.previousBalancePayments.filter(p => {
                            if (!p.date) return false;
                            const d = new Date(p.date);
                            return d.getFullYear() === year && d.getMonth() === (monthNum - 1) && d.getDate() > 15;
                        }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0)
                        : 0;
                    reportTitleKey = 'reportTitleAfterFifteenth';
                     reportTitleParams = { days: (periodEndDayIndex - periodStartDayIndex + 1 > 0 ? periodEndDayIndex - periodStartDayIndex + 1 : 0), month: monthNameForTitle, year };
                    periodTypeForFooter = translate('reportPeriodAfter15thIndie');
                    break;
                default: return;
            }

            // Ensure periodStartDayIndex is not greater than periodEndDayIndex for calculations if month is too short
            const actualPeriodStartForCalc = (periodStartDayIndex > periodEndDayIndex && actualDaysInMonth > 0) ? periodEndDayIndex + 1 : periodStartDayIndex;
            const currentUserPeriodTotals = calculatePeriodTotals(currentUser, currentMonthKey, actualPeriodStartForCalc, periodEndDayIndex +1);
            const { totalPresent: p, totalOvertimeHours: ot, totalRent: r, totalFood: f, totalDailyReceived: rec, periodGross } = currentUserPeriodTotals;

            const currentUserRate = Number(userData.rate) || 0;
            const currentUserOvertimeRate = Number(userData.overtimeRate) || 8;
            const currentUserHazriTotal = p * currentUserRate;
            const currentUserOtAmount = (currentUserRate > 0 && currentUserOvertimeRate > 0) ? (ot * currentUserRate) / currentUserOvertimeRate : 0;

            if (finalBalanceContextKey === 'finalBalanceDueFullMonthContext') {
                const fullMonthTotalsForBalance = calculateFullMonthTotals(currentUser, currentMonthKey);
                 const fullMonthPrevBalPaymentsForBalance = (Array.isArray(currentMonthData.previousBalancePayments))
                    ? currentMonthData.previousBalancePayments.reduce((sum, payment) => {
                        if (!payment.date) return sum + (Number(payment.amount) || 0);
                        const dPay = new Date(payment.date);
                        if (dPay.getFullYear() === year && dPay.getMonth() === (monthNum-1)) {
                            return sum + (Number(payment.amount) || 0);
                        }
                        return sum;
                    }, 0) : 0;
                const actualMonthCarriedOver = Number(currentMonthData.carriedOverBalance) || 0;
                finalBalanceForReport = (fullMonthTotalsForBalance.grossTotal + actualMonthCarriedOver) - fullMonthTotalsForBalance.totalDailyReceived - fullMonthPrevBalPaymentsForBalance;
            } else {
                finalBalanceForReport = (periodGross + currentPeriodCarriedOverBalance) - rec - currentPeriodPrevBalPaymentsTotal;
            }

            let summaryHtml = `<h3>${translate('reportFor',{user:currentUser,title:translate(reportTitleKey, reportTitleParams)})}</h3>
                <p>${translate('attendanceSummary',{days:p.toFixed(2),rate:currentUserRate.toFixed(2),total:currentUserHazriTotal.toFixed(2)})}</p>
                <p>${translate('overtimeSummary',{hours:ot.toFixed(1),amount:currentUserOtAmount.toFixed(2),hoursPerDay:currentUserOvertimeRate})}</p>
                <p>${translate('rentSummary',{amount:r.toFixed(2)})}</p><p>${translate('foodSummary',{amount:f.toFixed(2)})}</p>
                <p><strong>${translate('currentPeriodGross',{amount:periodGross.toFixed(2)})}</strong></p>
                <p><strong>${translate(carriedOverBalanceContextKey,{amount:currentPeriodCarriedOverBalance.toFixed(2)})}</strong></p>
                <p><strong>${translate('totalOwed',{amount:(periodGross + currentPeriodCarriedOverBalance).toFixed(2)})}</strong></p><hr>
                <p>${translate('totalReceivedDaily',{amount:rec.toFixed(2)})}</p>
                <p>${translate('totalReceivedPrevBalance',{amount:currentPeriodPrevBalPaymentsTotal.toFixed(2)})} ${currentPeriodPrevBalPaymentsTotal===0?`(${translate('noPaymentsRecorded')})`:''}</p>
                <p><strong>${translate('totalAllReceived',{amount:(rec + currentPeriodPrevBalPaymentsTotal).toFixed(2)})}</strong></p><hr>`;

            combinedFinalBalanceForReport = finalBalanceForReport;
            otherUserFinalBalanceForReport = 0;

            if (selectedOtherUser && data[selectedOtherUser] && data[selectedOtherUser].isActive !== false) {
                const otherUserData = data[selectedOtherUser];
                const otherUserMonthData = otherUserData?.months?.[currentMonthKey];
                let otherUserFinalBalanceCalc = 0;
                if (otherUserMonthData) {
                    let ouPeriodCarried = 0;
                    let ouPeriodPrevBalPay = 0;
                    const ouPeriodTotals = calculatePeriodTotals(selectedOtherUser, currentMonthKey, actualPeriodStartForCalc, periodEndDayIndex +1);
                    if (calcType === 'fullMonth' || calcType === 'firstHalfIndependent' || calcType === 'firstHalfCurrent') {
                        ouPeriodCarried = Number(otherUserMonthData.carriedOverBalance) || 0;
                        ouPeriodPrevBalPay = (Array.isArray(otherUserMonthData.previousBalancePayments))
                            ? otherUserMonthData.previousBalancePayments.filter(p => {
                                if (!p.date) return (calcType === 'fullMonth' || calcType === 'firstHalfIndependent');
                                const d = new Date(p.date);
                                if (d.getFullYear() !== year || d.getMonth() !== (monthNum - 1)) return false;
                                if (calcType === 'fullMonth' || calcType.includes('Current')) return true;
                                return d.getDate() >= 1 && d.getDate() <= 15;
                            }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0) : 0;
                    } else if (calcType === 'afterFifteenthIndependent' || calcType === 'afterFifteenthCurrent'){
                        const ouFirstHTotals = calculatePeriodTotals(selectedOtherUser, currentMonthKey, 0, Math.min(15, actualDaysInMonth));
                        const ouPrevMActualCarried = Number(otherUserMonthData.carriedOverBalance) || 0;
                        const ouFirstHPrevBalP = (Array.isArray(otherUserMonthData.previousBalancePayments))
                            ? otherUserMonthData.previousBalancePayments.filter(p => {
                                if (!p.date) return true;
                                const d = new Date(p.date);
                                return d.getFullYear() === year && d.getMonth() === (monthNum - 1) && d.getDate() >= 1 && d.getDate() <= 15;
                            }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0) : 0;
                        if (calcType === 'afterFifteenthIndependent') {
                            ouPeriodCarried = (ouFirstHTotals.periodGross + ouPrevMActualCarried) - ouFirstHTotals.totalDailyReceived - ouFirstHPrevBalP;
                        } else {
                            ouPeriodCarried = ouPrevMActualCarried;
                        }
                        ouPeriodPrevBalPay = (Array.isArray(otherUserMonthData.previousBalancePayments))
                            ? otherUserMonthData.previousBalancePayments.filter(p => {
                                if (!p.date) return false;
                                const d = new Date(p.date);
                                if (d.getFullYear() !== year || d.getMonth() !== (monthNum - 1)) return false;
                                if (calcType.includes('Current')) return true;
                                return d.getDate() > 15;
                            }).reduce((sum, p) => sum + (Number(p.amount) || 0), 0) : 0;
                         if(calcType.includes('Current')){
                              ouPeriodPrevBalPay = (Array.isArray(otherUserMonthData.previousBalancePayments))
                                ? otherUserMonthData.previousBalancePayments.reduce((sum, p) => {
                                    if(!p.date) return sum + (Number(p.amount) || 0);
                                    const dPay = new Date(p.date);
                                    if(dPay.getFullYear() === year && dPay.getMonth() === (monthNum-1)) return sum + (Number(p.amount) || 0);
                                    return sum;
                                },0) :0;
                         }
                    }
                    if (finalBalanceContextKey === 'finalBalanceDueFullMonthContext') {
                        const ouFullMonthT = calculateFullMonthTotals(selectedOtherUser, currentMonthKey);
                        const ouActualMonthC = Number(otherUserMonthData.carriedOverBalance) || 0;
                        const ouFullMonthPBP = (Array.isArray(otherUserMonthData.previousBalancePayments)) ? otherUserMonthData.previousBalancePayments.reduce((s,p)=>{
                             if(!p.date) return s + (Number(p.amount) || 0);
                             const dPay = new Date(p.date);
                             if(dPay.getFullYear() === year && dPay.getMonth() === (monthNum-1)) return s + (Number(p.amount) || 0);
                             return s;
                        },0) :0;
                        otherUserFinalBalanceCalc = (ouFullMonthT.grossTotal + ouActualMonthC) - ouFullMonthT.totalDailyReceived - ouFullMonthPBP;
                    } else {
                        otherUserFinalBalanceCalc = (ouPeriodTotals.periodGross + ouPeriodCarried) - ouPeriodTotals.totalDailyReceived - ouPeriodPrevBalPay;
                    }
                    otherUserFinalBalanceForReport = otherUserFinalBalanceCalc;
                }
                summaryHtml += `<hr><h4>${translate('includeBalanceOf')} ${selectedOtherUser} (${translate('forUser', {user: ""})})</h4>
                                <p><strong>${translate('otherUserFinalBalance', {otherUser: selectedOtherUser, amount: otherUserFinalBalanceForReport.toFixed(2)})}</strong></p>`;
                combinedFinalBalanceForReport = parseFloat((finalBalanceForReport + otherUserFinalBalanceForReport).toFixed(2));
                summaryHtml += `<hr><p><strong>${translate('combinedFinalBalance', {currentUser: currentUser, otherUser: selectedOtherUser, amount: combinedFinalBalanceForReport.toFixed(2)})}</strong></p>`;
            } else {
                summaryHtml += `<p><strong>${translate(finalBalanceContextKey,{amount:finalBalanceForReport.toFixed(2)})}</strong></p>`;
            }

            monthlySummary.innerHTML = summaryHtml;
            document.getElementById('reportFooter').dataset.periodTypeForShare = periodTypeForFooter;
            updateTableFooter(currentMonthKey);
        }


        async function shareReport() {
             const reportArea = document.getElementById('reportArea');
            const monthlySummaryDiv = document.getElementById('summarySection');
            const tableContainer = document.getElementById('tableContainer');

            if (monthlySummaryDiv.style.display !== 'block' || monthlySummaryDiv.innerText.trim()==="" || monthlySummaryDiv.innerText.includes(translate('alertSelectUserMonth')) || !tableContainer || tableContainer.innerHTML.trim() === "") {
                 alert(translate('alertGenerateReportFirst')); return;
            }
            if (!currentUser || !currentlyViewedMonth || !data[currentUser]?.months?.[currentlyViewedMonth]) {
                 alert(translate('alertCannotGenerateImage')); return;
            }

            const elementsToHide = [
                document.getElementById('addPaymentForm'), document.getElementById('quickMonthChangeBtn'),
                document.getElementById('dataManagementButtons'), document.getElementById('userRate'),
                document.getElementById('userOvertimeRate'), document.getElementById('manualCarriedOverBalance'),
                document.getElementById('otherUserForReport'), document.getElementById('viewOverallReportBtn'),
                document.getElementById('overallSummarySection'),
                ...(document.getElementById('previousBalancePaymentsSection')?.querySelectorAll('.delete-payment-btn') || [])
            ].filter(el => el != null);
            document.querySelectorAll('#userQuickControls label').forEach(label => elementsToHide.push(label));

            const mainTableFooter = document.getElementById('attendanceTableFooter');
            let mainFooterOriginalDisplay = '';
            if (mainTableFooter && activeReportType !== 'fullMonth') {
                mainFooterOriginalDisplay = mainTableFooter.style.display;
                mainTableFooter.style.display = 'none';
            }

            const originalDisplays = elementsToHide.map(el => el.style.display);
            elementsToHide.forEach(el => { el.style.display = 'none'; });

            const elementsToReplace = [];
            document.querySelectorAll('#tableContainer tbody td input, #tableContainer tbody td .note-preview').forEach(element => {
                const td = element.closest('td'); if (!td) return;
                const span = document.createElement('span'); let displayValue = "";
                if (element.tagName === 'INPUT') {
                    const field = element.dataset.field; displayValue = element.value;
                    if (['overtime', 'rent', 'food', 'received'].includes(field)) {
                        const num = parseFloat(displayValue);
                        if (isNaN(num) || num === 0) displayValue = '';
                        else { let precision = (field === 'overtime') ? 1 : 2; displayValue = String(Number(num.toFixed(precision))); if (displayValue === "0") displayValue = ""; }
                    } else if (field === 'status') displayValue = displayValue.trim().toUpperCase();
                    else if (field === 'updated_date' || field === 'updated_time') {
                        if (td.classList.contains('edited-datetime-cell')) { span.style.display = 'block'; span.style.textAlign = 'center'; span.style.fontSize = '0.80em';}
                    }
                } else if (element.classList.contains('note-preview')) {
                    displayValue = element.textContent; span.style.display = 'inline-block'; span.style.fontSize = '0.9em';
                    span.style.color = window.getComputedStyle(element).color; span.style.textAlign = 'left';
                    span.style.paddingLeft = '5px'; span.style.width = '100%'; span.style.overflow = 'hidden';
                    span.style.textOverflow = 'ellipsis'; span.style.whiteSpace = 'nowrap';
                }
                span.textContent = displayValue; const compStyle = window.getComputedStyle(element);
                 if (element.tagName === 'INPUT' && !td.classList.contains('edited-datetime-cell')) {
                    span.style.cssText += `display:inline-block;width:100%;box-sizing:border-box;padding:${compStyle.padding};text-align:${td.offsetWidth<=35?'center':compStyle.textAlign};vertical-align:middle;line-height:${compStyle.lineHeight};font-size:${compStyle.fontSize};font-family:${compStyle.fontFamily};color:${compStyle.color};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background-color:transparent;border:none;`;
                    td.style.verticalAlign='middle';
                }
                elementsToReplace.push({originalElement: element, parentTd: td, tempSpan: span});
                try { td.replaceChild(span, element); } catch(e) {console.warn("Error replacing element for html2canvas", e)}
            });

            await new Promise(r => setTimeout(r, 50));
            const footerDiv = document.getElementById('reportFooter');
            const periodTypeForShare = footerDiv.dataset.periodTypeForShare || translate('reportPeriodFullMonth');

            if(footerDiv){
                const now = new Date();
                const formatter = new Intl.DateTimeFormat(currentLanguage==='hi'?'hi-IN-u-nu-latn':'en-GB', {year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
                let otherUserBalanceStringForFooter = "";
                let finalBalanceToDisplayInFooter = finalBalanceForReport;
                const otherUserSelect = document.getElementById('otherUserForReport');
                const selectedOtherUserForShare = otherUserSelect ? otherUserSelect.value : '';
                if (selectedOtherUserForShare && data[selectedOtherUserForShare] && data[selectedOtherUserForShare].isActive !== false && data[selectedOtherUserForShare]?.months?.[currentlyViewedMonth]) {
                     if (otherUserFinalBalanceForReport !== 0 || finalBalanceForReport !== 0) {
                         otherUserBalanceStringForFooter = translate('footerIncludeOtherUserFinalBalance', {
                             otherUser: selectedOtherUserForShare, otherUserFinalBalance: otherUserFinalBalanceForReport.toFixed(2),
                             combinedBalance: combinedFinalBalanceForReport.toFixed(2)
                         });
                         finalBalanceToDisplayInFooter = combinedFinalBalanceForReport;
                     }
                }
                 footerDiv.textContent = translate('reportGeneratedOn',{
                     user:currentUser, monthYear:currentlyViewedMonth, periodType: periodTypeForShare,
                     balance:finalBalanceToDisplayInFooter.toFixed(2), dateTime:formatter.format(now), otherUserBalanceString: otherUserBalanceStringForFooter
                 });
                 await new Promise(r => setTimeout(r, 50));
            }

            const restoreElements = () => {
                elementsToHide.forEach((el, i) => { if(el) el.style.display = originalDisplays[i]; });
                elementsToReplace.forEach(({originalElement, parentTd, tempSpan}) => {
                     if(parentTd && tempSpan && parentTd.contains(tempSpan)){
                        try { parentTd.replaceChild(originalElement, tempSpan); } catch(e){}
                     }
                     if(parentTd) parentTd.style.verticalAlign = '';
                });
                if (mainTableFooter && activeReportType !== 'fullMonth') {
                    mainTableFooter.style.display = mainFooterOriginalDisplay;
                }
            };

            try {
                const canvas = await html2canvas(reportArea, {
                    scale: 2, logging: false, useCORS: true,
                    backgroundColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                    ignoreElements: el => el.classList.contains('delete-payment-btn') || el.id === 'dataManagementButtons' ||
                               el.id === 'userTabs' || el.id === 'controlsHeader' || el.classList.contains('control-icon') ||
                               el.closest('#topControls') !== null || el.id === 'overallSummarySection' ||
                               (el.id === 'attendanceTableFooter' && activeReportType !== 'fullMonth')
                });
                if(!canvas) throw new Error("Canvas creation failed.");
                canvas.toBlob(async blob => {
                    restoreElements(); if(!blob){ alert(translate('alertCouldNotGenerateImage')); return; }
                    const file = new File([blob], `attendance_report_${currentUser}_${currentlyViewedMonth}_${activeReportType}.png`, {type:'image/png'});
                    const [yrF, mthF] = currentlyViewedMonth.split('-').map(Number);
                    const shareTitle = translate('reportFor', { user: currentUser,
                        title: `${new Intl.DateTimeFormat(currentLanguage==='hi'?'hi-IN':'en-US',{month:'long',year:'numeric'}).format(new Date(yrF,mthF-1,1))}${periodTypeForShare}`
                    });
                    let shareBalanceAmountText = "";
                    const otherUserSelectForShare = document.getElementById('otherUserForReport');
                    const selectedOtherUserForShareText = otherUserSelectForShare ? otherUserSelectForShare.value : '';
                    if (selectedOtherUserForShareText && data[selectedOtherUserForShareText] && data[selectedOtherUserForShareText].isActive !== false && data[selectedOtherUserForShareText]?.months?.[currentlyViewedMonth]) {
                         shareBalanceAmountText = translate('combinedFinalBalance', {currentUser: currentUser, otherUser: selectedOtherUserForShareText, amount: combinedFinalBalanceForReport.toFixed(2)});
                    } else {
                        const finalBalanceKey = (activeReportType.includes('Current'))
                            ? 'finalBalanceDueFullMonthContext'
                            : 'finalBalanceDueForPeriod';
                         shareBalanceAmountText = translate(finalBalanceKey, {amount: finalBalanceForReport.toFixed(2)});
                    }
                    const shareText = `${shareTitle}\n${shareBalanceAmountText}`;
                    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
                        try {
                            await navigator.share({ files: [file], title: shareTitle, text: shareText });
                        } catch(err) {
                            if(err.name !== 'AbortError'){ alert(translate('alertWebShareFailed')); downloadBlob(blob, file.name); }
                        }
                    } else { downloadBlob(blob, file.name); alert(translate('alertImageDownloaded')); }
                }, 'image/png', 0.9);
            } catch(err) { restoreElements(); alert(`${translate('alertCouldNotGenerateImage')}\nError: ${err.message}`); }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a);
            a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function getCurrentMonth() {
            const d = new Date();
            return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}`;
        }

        function toggleDataMenu() {
            const menu = document.getElementById('dataManagementButtons');
            const archiveBtn = document.getElementById('archiveUserBtn');
            const toggleArchivedBtn = document.getElementById('toggleArchivedUsersBtn');
            if (menu.style.display === 'none' || menu.style.display === "") {
                menu.style.display = 'flex';
                if (archiveBtn) {
                    if (currentUser && data[currentUser]) {
                         archiveBtn.style.display = 'inline-block'; applyTranslationsToUI();
                    } else archiveBtn.style.display = 'none';
                }
                if (toggleArchivedBtn) {
                    const hasArchived = Object.values(data).some(u => u.isActive === false);
                    toggleArchivedBtn.style.display = hasArchived || showArchivedUsers ? 'inline-block' : 'none';
                    applyTranslationsToUI();
                }
            } else menu.style.display = 'none';
        }

        function clearAllData() {
            if(confirm(translate('confirmClearData'))){
                if(renderTimeout) clearTimeout(renderTimeout);
                localStorage.removeItem('attendanceData'); localStorage.removeItem('lastSelectedUser');
                localStorage.removeItem('activeReportType'); // Clear stored report type
                data = {}; currentUser = null; currentlyViewedMonth = null; activeReportType = 'fullMonth'; // Reset to default
                finalBalanceForReport = 0; combinedFinalBalanceForReport = 0; otherUserFinalBalanceForReport = 0;
                importDataBuffer = null; showArchivedUsers = false;
                fullRender();
                document.getElementById("newUserName").value = "";
                document.getElementById("userTabs").innerHTML = ""; document.getElementById("userTabs").style.display = 'none';
                populateOtherUserDropdown();
                setDarkMode(localStorage.getItem('darkMode') === 'enabled');
                currentLanguage = localStorage.getItem('appLanguage') || 'hi';
                document.documentElement.lang = currentLanguage; applyTranslationsToUI();
                localStorage.removeItem('attendanceData');
                alert(translate('alertDataCleared'));
                const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
            }
        }

        function exportData() {
            try{
                 const exportObj = {
                     attendanceData: data,
                     exportDate: new Date().toISOString(),
                     appVersion: "1.9.1", // Version increment for localStorage of activeReportType
                     language: currentLanguage,
                     darkMode: localStorage.getItem('darkMode'),
                     showArchivedUsers: showArchivedUsers,
                     activeReportType: localStorage.getItem('activeReportType') || 'fullMonth' // Also export the persisted report type
                 };
                downloadBlob(new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'}),`attendance_data_${new Date().toISOString().slice(0,10)}.json`);
                alert(translate('alertDataExported'));
                const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
            } catch(e){ alert(translate('alertExportFailed',{error:e.message})); }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0]; if(!file){ alert(translate('alertNoFileSelected')); return; }
            if(file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')){
                alert(translate('alertSelectJsonFile')); event.target.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const parsedData = JSON.parse(e.target.result);
                    if(!parsedData || typeof parsedData !== 'object' || !parsedData.attendanceData || typeof parsedData.attendanceData !== 'object') {
                        throw new Error(translate('alertInvalidImportFormat'));
                    }
                    // Try to restore activeReportType from import if available
                    if (parsedData.activeReportType) {
                        localStorage.setItem('activeReportType', parsedData.activeReportType);
                        activeReportType = parsedData.activeReportType; // Update in-memory var too
                    }

                    const importedAttendanceData = parsedData.attendanceData; let importMigrationNeeded = false;
                     for(const userName in importedAttendanceData){
                         if(importedAttendanceData[userName] && typeof importedAttendanceData[userName] === 'object') {
                             if(importedAttendanceData[userName].overtimeRate === undefined || typeof importedAttendanceData[userName].overtimeRate !== 'number' || importedAttendanceData[userName].overtimeRate <= 0) {
                                  importedAttendanceData[userName].overtimeRate = 8; importMigrationNeeded = true;
                             }
                             if (importedAttendanceData[userName].months && typeof importedAttendanceData[userName].months === 'object') {
                                 for (const monthKey in importedAttendanceData[userName].months) {
                                     if (importedAttendanceData[userName].months[monthKey] && typeof importedAttendanceData[userName].months[monthKey] === 'object') {
                                         if (Array.isArray(importedAttendanceData[userName].months[monthKey].days)) {
                                              importedAttendanceData[userName].months[monthKey].days.forEach(d => {
                                                   if (d && typeof d === 'object' && d.location !== undefined) { delete d.location; importMigrationNeeded = true; }
                                                   if (d && typeof d === 'object' && d.updated === undefined) { d.updated = ''; importMigrationNeeded = true; }
                                              });
                                         }
                                     }
                                 }
                             }
                              if (importedAttendanceData[userName].isActive === undefined) { importedAttendanceData[userName].isActive = true; importMigrationNeeded = true; }
                         }
                     }
                     if(importMigrationNeeded) console.log("Migration performed on imported data during preview.");
                    importDataBuffer = importedAttendanceData; showImportPreview(importDataBuffer);
                } catch(err) { alert(translate('alertImportProcessingError',{error: err.message}));
                } finally { event.target.value = ''; }
            };
            reader.onerror = () => { alert(translate('alertFileReadError')); event.target.value = ''; };
            reader.readAsText(file);
        }

        function showImportPreview(importData) {
             const modal = document.getElementById('importPreviewModal');
             const content = document.getElementById('importPreviewContent');
             const footer = modal.querySelector('.modal-footer');
             const count = importData && typeof importData === 'object' ? Object.keys(importData).length : 0;
            if (count === 0) {
                content.innerHTML = `<p>${translate('alertNoImportData')}</p>`; footer.style.display = 'none';
            } else {
                footer.style.display = 'flex';
                let html = `<div class="preview-section"><div class="preview-header">${translate('importPreviewTitle')}:</div>
                                <p>${translate('importContainsUsers', { count })}</p></div><div class="user-preview">`;
                const userNames = Object.keys(importData).slice(0, 5);
                userNames.forEach(name => {
                    const u = importData[name];
                    const statusText = (u && u.isActive === false) ? ` (${translate('archiveUser')})` : '';
                    const rate = (u && u.rate !== undefined) ? u.rate : 0;
                    const otRate = (u && u.overtimeRate !== undefined) ? u.overtimeRate : 8;
                    const monthCount = (u && u.months) ? Object.keys(u.months).length : 0;
                    html += `<p><strong>${name}</strong>${statusText} - ${translate('rateLabel')} ${rate}, ${translate('overtimeRateLabel')} ${otRate}, Months: ${monthCount}</p>`;
                });
                if(count > 5) html += `<p>${translate('andMoreUsers',{count: count - 5})}</p>`;
                html += `</div><div class="preview-section"><div class="preview-header">${translate('currentData')}</div>
                            <p>${translate('youHaveUsers',{count:Object.keys(data||{}).length})}</p></div>
                        <div class="import-option"><p><strong>${translate('importChooseOption')}</strong></p>
                            <ul><li>${translate('importOptionMerge')}</li><li>${translate('importOptionReplace')}</li></ul></div>`;
                content.innerHTML = html;
            }
            modal.style.display='block'; applyTranslationsToUI();
            const menu = document.getElementById('dataManagementButtons'); if(menu) menu.style.display = 'none';
        }

        function confirmImport(mode) {
            if(!importDataBuffer){ alert(translate('alertNoImportData')); closeImportModal(); return; }
            try {
                if(mode === 'replace'){
                    data = JSON.parse(JSON.stringify(importDataBuffer));
                    localStorage.removeItem('lastSelectedUser');
                    // activeReportType would have been set during handleFileUpload if present in import file
                } else if(mode === 'merge'){
                    for(const name in importDataBuffer){
                        const importedUser = importDataBuffer[name];
                        if (importedUser && typeof importedUser === 'object') {
                            if (data[name]) {
                                data[name].rate = importedUser.rate ?? data[name].rate;
                                data[name].overtimeRate = (importedUser.overtimeRate !== undefined && typeof importedUser.overtimeRate === 'number' && importedUser.overtimeRate > 0)
                                                          ? importedUser.overtimeRate : (data[name].overtimeRate ?? 8);
                                data[name].isActive = importedUser.isActive ?? data[name].isActive;
                                data[name].months = data[name].months || {};
                                if (importedUser.months && typeof importedUser.months === 'object') {
                                    for(const mKey in importedUser.months){
                                        const importedMonthData = importedUser.months[mKey];
                                        if (importedMonthData && typeof importedMonthData === 'object') {
                                            data[name].months[mKey] = JSON.parse(JSON.stringify(importedMonthData));
                                            if(typeof data[name].months[mKey].carriedOverBalance !== 'number') data[name].months[mKey].carriedOverBalance = 0;
                                            if(!Array.isArray(data[name].months[mKey].previousBalancePayments)) data[name].months[mKey].previousBalancePayments = [];
                                            if(!Array.isArray(data[name].months[mKey].days)) data[name].months[mKey].days = [];
                                            if (data[name].months[mKey].days) {
                                                 data[name].months[mKey].days.forEach(d => {
                                                      if (d && typeof d === 'object' && d.location !== undefined) delete d.location;
                                                      if (d && typeof d === 'object' && d.updated === undefined) d.updated = '';
                                                 });
                                            }
                                        }
                                    }
                                }
                            } else {
                                data[name] = JSON.parse(JSON.stringify(importedUser));
                                if (data[name].isActive === undefined) data[name].isActive = true;
                                if(data[name].overtimeRate === undefined || typeof data[name].overtimeRate !== 'number' || data[name].overtimeRate <= 0) data[name].overtimeRate = 8;
                                data[name].months = data[name].months || {};
                                if (data[name].months) {
                                     for (const mKey in data[name].months) {
                                          if (data[name].months[mKey] && typeof data[name].months[mKey] === 'object') {
                                              if (typeof data[name].months[mKey].carriedOverBalance !== 'number') data[name].months[mKey].carriedOverBalance = 0;
                                              if (!Array.isArray(data[name].months[mKey].previousBalancePayments)) data[name].months[mKey].previousBalancePayments = [];
                                              if (!Array.isArray(data[name].months[mKey].days)) data[name].months[mKey].days = [];
                                                if (data[name].months[mKey].days) {
                                                     data[name].months[mKey].days.forEach(d => {
                                                          if (d && typeof d === 'object' && d.location !== undefined) delete d.location;
                                                          if (d && typeof d === 'object' && d.updated === undefined) d.updated = '';
                                                     });
                                                }
                                          }
                                     }
                                }
                            }
                        }
                    }
                }
                saveData();
                loadData(); // This will also load the activeReportType from localStorage
                closeImportModal();
                alert(translate('alertDataImported',{mode: mode==='replace' ? translate('replaceAllData') : translate('mergeData')}));
            } catch(e){ alert(translate('alertImportFailed',{error: e.message})); closeImportModal();
            } finally { importDataBuffer = null; }
        }

        function closeImportModal() {
             document.getElementById('importPreviewModal').style.display = 'none';
             importDataBuffer = null;
        }

        function openNotesModal(monthKey, dayIndex) {
            if (!currentUser || !data[currentUser]?.months?.[monthKey]?.days?.[dayIndex]) {
                console.error("Cannot open notes modal: Invalid data path."); return;
            }
            const dayData = data[currentUser].months[monthKey].days[dayIndex];
            const modal = document.getElementById('notesModal');
            const textarea = document.getElementById('modalNoteTextarea');
            const monthKeyInput = document.getElementById('modalNoteMonthKey');
            const dayIndexInput = document.getElementById('modalNoteDayIndex');
            textarea.value = dayData.notes || '';
            monthKeyInput.value = monthKey;
            dayIndexInput.value = dayIndex;
            const modalTitle = modal.querySelector('.modal-title');
            const dateForTitle = dayData.date || `${dayIndex + 1}/${monthKey.split('-')[1]}`;
            modalTitle.dataset.translateKey = 'notesModalTitle';
            modalTitle.textContent = `${translate('notesModalTitle')} - ${dateForTitle}`;
            modal.style.display = 'block';
            textarea.focus();
            applyTranslationsToUI();
        }

        function closeNotesModal() {
            const modal = document.getElementById('notesModal');
            modal.style.display = 'none';
            document.getElementById('modalNoteTextarea').value = '';
            document.getElementById('modalNoteMonthKey').value = '';
            document.getElementById('modalNoteDayIndex').value = '';
        }

        function saveModalNote() {
            const textarea = document.getElementById('modalNoteTextarea');
            const monthKey = document.getElementById('modalNoteMonthKey').value;
            const dayIndex = parseInt(document.getElementById('modalNoteDayIndex').value, 10);
            if (!currentUser || !monthKey || isNaN(dayIndex) || !data[currentUser]?.months?.[monthKey]?.days?.[dayIndex]) {
                console.error("Cannot save note: Invalid data path or index.");
                alert("Error saving note."); closeNotesModal(); return;
            }
            const newNoteText = textarea.value.trim();
            const dayData = data[currentUser].months[monthKey].days[dayIndex];
            if ((dayData.notes || '') !== newNoteText) {
                dayData.notes = newNoteText;
                dayData.updated = new Date().toISOString();
                saveData();
                const notesCell = document.querySelector(`#tableContainer td.notes-cell[onclick="openNotesModal('${monthKey}', ${dayIndex})"]`);
                if (notesCell) {
                    const previewSpan = notesCell.querySelector('.note-preview');
                    if (previewSpan) {
                        previewSpan.textContent = (newNoteText || '').substring(0, 20) + ((newNoteText || '').length > 20 ? '...' : '');
                    }
                }
                const dateInputElement = document.querySelector(`input[data-month="${monthKey}"][data-index="${dayIndex}"][data-field="updated_date"]`);
                const timeInputElement = document.querySelector(`input[data-month="${monthKey}"][data-index="${dayIndex}"][data-field="updated_time"]`);
                if (dateInputElement && timeInputElement && dayData.updated) {
                    dateInputElement.value = new Date(dayData.updated).toLocaleDateString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                    timeInputElement.value = new Date(dayData.updated).toLocaleTimeString(currentLanguage === 'hi' ? 'hi-IN-u-hc-h12' : 'en-GB', {hour: '2-digit', minute: '2-digit', hourCycle: 'h23'});
                }
                if (document.getElementById('summarySection').style.display === 'block') showSummary(activeReportType);
                if (document.getElementById('overallSummarySection').style.display === 'block') displayOverallReport();
            }
            closeNotesModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // activeReportType is loaded from localStorage here
             const overallReportBtn = document.getElementById('viewOverallReportBtn');
             if(overallReportBtn) overallReportBtn.addEventListener('click', displayOverallReport);
             const paymentDateInput = document.getElementById('paymentDate');
             if (paymentDateInput) {
                paymentDateInput.valueAsDate = new Date();
             }
             if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => console.log('SW registered: ', registration.scope))
                        .catch(registrationError => console.log('SW registration failed: ', registrationError));
                });
            }
        });
    </script>
</body>
</html>